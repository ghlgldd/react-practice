<!DOCTYPE HTML>
<html>
<head>
	<title></title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE10">
	<link rel="stylesheet" type="text/css" href="css/kendo.common.min.css">
	<link rel="stylesheet" type="text/css" href="css/kendo.default.min.css">
	<link rel="stylesheet" type="text/css" href="css/manageSys.css">
	<script src="lib/kendo/js/jquery.min.js"></script>
	<script src="lib/kendo/js/kendo.custom.min.js"></script>
	<script src="lib/kendo/js/jszip.min.js"></script>
	<script src="js/wp.js"></script>
</head>
<body>
	<div id="user_id" style="display:none"></div>
	<div id="first_name" style="display:none"></div>
	<div id="last_name" style="display:none"></div>
	<div id="multi">
		<div id="multi_content" data-template="multi_query_form" data-bind="source: this" style="width:100%"></div>
	</div>
    <div id="global_alert_win"><p></p><span Class="btn no"></span><span Class="btn yes"></span></div>
	<script id="multi_query_form" type="text/x-kendo-template">
	<div>
		<div id="multi_button_frame">
			<button type="button" Class="k-button" id="cascade_mulit" data-bind="click:cascade" >Cascade</button>
			<button type="button" Class="k-button" id="create_mulit" data-bind="click:create_query">Create Query</button>
		</div>
		<div id="multi_error_message_for_role" style="display:none;">You are not authorized to create queries</div>
		<div id="multi_grid"></div>
		<div id="add_row_window"></div>
	</div>
	</script>

	<script  id="multi_template" type="text/x-kendo-template">
		<tr data-uid="#= uid #" style="text-align:center">
	        <td >
         #=patient.PatientId#
        </td>
        <td  >
           #=study.StudyName#
        </td>
        <td  >
          #=site.SiteId#
        </td>
        <td  >
          #=crf.CRFName#
        </td>
        <td  >
           #=visit.VisitName#
        </td>
        <td  >
          #=assign.name#
        </td>
        <td class="multi_issue">
           #=issue#
        </td>
        <td class="multi_querytext">
             #=querytext#
        </td>
	    </tr>
	</script>
	<script>
		var multi = (function () {
		    var login_username = "";
		    var login_user_id = "";
		    var _mulit_study_id = "";
		    function to_utctime() {
		        var _time_lag = new Date().getTimezoneOffset();
		        _time_lag = _time_lag * 60 * 1000;
		        var local_seconds = new Date().getTime();
		        var utc_seconds = local_seconds + _time_lag;
		        var utc_time_a = kendo.toString(new Date(utc_seconds), 'MM/dd/yyyy h:mm:ss tt');
		        return utc_time_a;
		    };
			function check_v(data) {
				var _upload_data = [];
				var create_data = to_utctime();
				var _upload_data_obj = { "StudyId": "", "StudyName": "", "SiteId": "", "SiteName": "", "PatientID": "", "CRFId": "", "CRFName": "", "VisitId": "", "VisitName": "", "Issue": "", "QueryText": "", "AssignTo": "", "Openedby": "", "OpenedById": "", "OpenDate": "" };
				var t_bool;
				for (var i = 0; i < data.length; i++) {
					t_bool = [];
					t_bool.push(Boolean($.trim(data[i].crf.CRFId)));
					t_bool.push(Boolean($.trim(data[i].crf.CRFName)));
					t_bool.push(Boolean($.trim(data[i].site.SiteId)));
					t_bool.push(Boolean($.trim(data[i].study.StudyName)));
					t_bool.push(Boolean($.trim(data[i].visit.VisitId)));
					t_bool.push(Boolean($.trim(data[i].visit.VisitName)));
					t_bool.push(Boolean($.trim(data[i].querytext)));
					t_bool.push(Boolean($.trim(data[i].issue)));
					t_bool.push(Boolean($.trim(data[i].patient.PatientId)));
					t_bool.push(Boolean(($.trim(data[i].patient.SiteId + ''))));
					for (var m = 1, l = t_bool.length; m < l; m++) {
						if (t_bool[0] == t_bool[m]) {

						} else {
							return false;
						}
					}
					if (t_bool[0]) {
						_upload_data_obj = { "StudyId": data[i].study.StudyName, "StudyName": data[i].study.StudyName, "SiteId": data[i].site.SiteId, "SiteName": data[i].site.SiteId, "PatientID": data[i].patient.PatientId, "CRFId": data[i].crf.CRFId, "CRFName": data[i].crf.CRFName, "VisitId": data[i].visit.VisitId, "VisitName": data[i].visit.VisitName, "Issue": data[i].issue, "QueryText": data[i].querytext, "AssignTo": data[i].assign.text, "Openedby": login_username, "OpenedById": login_user_id, "OpenDate": create_data, "SpotfireQueryID":data[i].site.SpotfireQueryID};
						_upload_data.push(_upload_data_obj);
					}
				}
				return _upload_data;
			}


			function mulit_vm(data) {
				var vm = kendo.observable({
					create_query: function () {
						$('body').append('<div id="multi_laoding" style="position: absolute;top: 0px;z-index: 999;width: 100%;height: 100%;background-color:rgba(0,0,0,0);cursor:wait"></div>');
						var m_grid = $("#multi_grid").data("kendoGrid");
						var ds = check_v(m_grid.dataSource.data());
						if (ds) {
							if (ds.length == 0) {
								$('#multi_laoding').remove();
							    manageSys.utils.alertMsg("Confirmation alert", 'Please fill all the attributes.', function () {});
								return;
							}

							var create_datasource_mulit = new kendo.data.DataSource({
								transport: {
									read: {
										dataType: "json",
										contentType: 'application/json',
										url: QMT_RESTFUL_URL + "QMT/PostCreateQuery",
										type: "POST"
									},
									parameterMap: function () {
										return JSON.stringify(ds);
									}
								},
								schema: {
									data: function (response) {
										if (response.ResponseCode == "WP1022") {
											var _m_id_list = [];
											if(response.CreateResponse != null){
												for(var i=0;i<response.CreateResponse.length;i++){
													_m_id_list.push(response.CreateResponse[i].QueryId)
												}
											}
											_m_id_list = _m_id_list.toString();
											if(_m_id_list !=""){
												var _success_message = "Clinical Data Queries "+_m_id_list+" created successfully";
											}else{
												var _success_message = response.ResponseMessage;
											}
											manageSys.utils.alertMsg("Confirmation alert",_success_message, function () {});
											$('#create_mulit').removeAttr("disabled");
											$("#multi").data("kendoWindow").close();
										} else {
											manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () {});
											$('#create_mulit').removeAttr("disabled");
										}
										$('#multi_laoding').remove();
										return [];
									}
								},
								error: function (response) {
									$('#multi_laoding').remove();
								}
							});
							create_datasource_mulit.read();
							$('#create_mulit').attr("disabled", "disabled");
						} else {
						    manageSys.utils.alertMsg("Confirmation alert", 'Please fill all the attributes.', function () { });
							return;
						}
					},
					cascade: function () {
						var m_grid = $("#multi_grid").data("kendoGrid");
						var view = m_grid.dataSource.view();
						if($.trim(view[0].issue)== "" ||$.trim(view[0].querytext) == ""){
							manageSys.utils.alertMsg("Confirmation alert","Kindly fill the first row to Cascade 'Issue' & 'Query Text'", function(){});
							return
						}
						manageSys.utils.alertMsg("Confirmation alert", "This will replace all the Issue and Query text fields with the details in first row, do you want to proceed ?",[{
		    				name:'Yes',Class:'btn yes', css:{}, action:function(e){
								for(var i=1;i<view.length;i++){
									if($.trim(view[i].patient.PatientId) != ""){
										if(view[0].issue !=undefined ){
											view[i].issue = view[0].issue;
										}
										if(view[0].querytext !=undefined ){
											view[i].querytext = view[0].querytext;
										}
									}
								}
								m_grid.refresh();
		    				}},{name:'No',Class:'btn no', css:{}, action:function(e){
		    					return
		    			}}]);
					}
				});
				return vm;
			}
			function drivelist(listdata) {
				var vm = kendo.observable({
					data: listdata					
				});
                return vm;
            }
			function UrlParamHash(url) {
				var params = { "pTransactionID": "", "pUserID": "" }, h;
				var hash = url.slice(url.indexOf("?") + 1).split('&');
				for (var i = 0; i < hash.length; i++) {
					h = hash[i].split("=");
					if (h[0].toLowerCase() == "ptransactionid") {
						params.pTransactionID = h[1];
					} else if (h[0] == "pUserID") {
						params.pUserID = h[1];
					}
				}
				return params;
			}
			return {
			    init: function () {
			    	var _url = window.location.search;
			            var url_array = UrlParamHash(_url);
			            var _pTransactionID = url_array.pTransactionID;
			            login_user_id = url_array.pUserID;
			            $.ajaxSetup({
			                beforeSend: function (xhr) {
			                    xhr.setRequestHeader("UserId", login_user_id);
			                }
			            });
			        multi.getUserName(function () {
			            var viewModel = mulit_vm();
			            kendo.bind($('#multi_content'), viewModel);
			            var w_width = Math.floor($(window).width() * 0.8);
			            var patientid_list = {};
			            patientid_list.PatientIdList = [];
			            var crf_data_source = [];
			            var visit_data_source = [];
			            $("#multi").kendoWindow({
			                height: '600px',
			                width: '1000px',
			                title: "Multi-patient Query Form",
			                modal: true,
			                visible: false,
			                resizable: false,
			                draggable: false,
			                animation: {
			                    open: {
			                        duration: 100
			                    }
			                },
			                visible: false
			            });
			            var dataSourceaaa = new kendo.data.DataSource({
			                schema: {
			                    model: {
			                        fields: {
			                            patient: { defaultValue: { SiteId: " ", PatientId: " " } },
			                            study: { defaultValue: { StudyId: " ", StudyName: " " } },
			                            site: { defaultValue: { SiteId: " ", SpotfireQueryID: " " } },
			                            crf: { defaultValue: { CRFId: " ", CRFName: " " } },
			                            visit: { defaultValue: { VisitId: " ", VisitName: " " } },
			                            assign:{defaultValue:{name: "DM", text: "DM"}},
			                            issue: {},
			                            querytext: {}
			                        }
			                    }
			                }
			            });

			            var multi_auto_complete_data = new kendo.data.DataSource({
			                transport: {
			                    read: {
			                        dataType: "json",
			                        contentType: 'application/json',
			                        url: QMT_RESTFUL_URL + "QMT/GetMultipatientData",
			                        type: "POST"
			                    },
			                    parameterMap: function () {
			                        return JSON.stringify(patientid_list);
			                    }
			                },
			                schema: {
			                    data: "CreateQueryData"
			                },
			                error: function (e) {
			                }
			            });

			            var _datasource_assign = new kendo.data.DataSource({
			                data: [
                              { name: "DM", text: "DM" },
                              { name: "CRA", text: "CRA" }
			                ]
			            });

			            $("#multi_grid").kendoGrid({
			                width: "300px",
			                dataSource: dataSourceaaa,
			                dataBound: function () {
			                	$(".multi_issue").bind("click keydown",function(){
									$('.multi_issue').find('input').attr('maxlength','3999');
								});
								$(".multi_querytext").bind("click keydown",function(){
									$('.multi_querytext').find('input').attr('maxlength','3999');
								});
			                },
			                scrollable: false,
			                rowTemplate: kendo.template($("#multi_template").html()),
			                columns: [
                                        { field: "patient", title: "Patient ID*", editor: patientDropDownEditor, template: "#=patient.PatientId#" },
                                        { field: "study", title: "Study*", editor: studyDropDownEditor, template: "#=study.StudyName#" },
                                        { field: "site", title: "Site*", editor: siteDropDownEditor, template: "#=site.SiteId#" },
                                        { field: "crf", title: "CRF*", editor: crfDropDownEditor, template: "#=crf.CRFName#", width: 150 },
                                        { field: "visit", title: "Visit*", editor: visitDropDownEditor, template: "#=visit.VisitName#", width: 100 },
                                        { field: "assign", title: "AssignTo*", editor: assignDropDownEditor, template: "#=assign.name#", width: 100 },
                                        { field: "issue", title: "Issue*" },
                                        { field: "querytext", title: "Query Text" },
			                ],
			                editable: true
			            });

			            function patientDropDownEditor(container, options){
							container.text(options.model.patient.PatientId);
						};

			            function studyDropDownEditor(container, options) {
			                container.text(options.model.study.StudyName);
			            };

			            function siteDropDownEditor(container, options) {
			               container.text(options.model.site.SiteId);
			            };

			            function crfDropDownEditor(container, options){
							container.text(options.model.crf.CRFName);
						};

						function visitDropDownEditor(container, options){
					    	container.text(options.model.visit.VisitName);
						};

						function assignDropDownEditor(container, options){
					        $('<input required data-text-field="text" data-value-field="name" data-bind="value:' + options.field + '"/>')
					            .appendTo(container)
					            .kendoDropDownList({
					                autoBind: true,
					                dataSource: _datasource_assign
					        	});
						};
			            var get_mulitdata_datasource = new kendo.data.DataSource({
			                transport: {
			                    read: {
			                        dataType: "json",
			                        url: QMT_RESTFUL_URL + "QMT/" + _pTransactionID + "/SpotfireNewMultipatient",
			                    }
			                },
			                schema: {
			                    data: "CreateQueryData"
			                },
			                error: function (response) {
			                    manageSys.utils.alertMsg("Confirmation alert", 'Load data Error Please reload this page.', function () {});
			                }
			            });

			            get_mulitdata_datasource.read().then(function () {
			                var _data = get_mulitdata_datasource.data();
			                multi.add_data(_data);
			            });
			        });

			    },
			    add_data: function (data) {
			        var m_grid = $("#multi_grid").data("kendoGrid");
			        var _length = 1;
			        if (_length < data.length) {
			            _length = data.length
			        }
			        for (i = 0; i < _length; i++) {
			            m_grid.addRow();
			        }
			        var view = m_grid.dataSource.view();
			        for (var i = 0; i < data.length; i++) {
			            view[i].assign.name = data[i].AssignTo;
			            view[i].assign.text = data[i].AssignTo;
			            view[i].crf.CRFId = data[i].CRFId;
			            view[i].crf.CRFName = data[i].CRFName;
			            view[i].issue = '';
			            view[i].patient.PatientId = data[i].PatientID;
			            view[i].patient.SiteId = data[i].SiteId;
			            view[i].querytext = '';
			            view[i].site.SiteId = data[i].SiteId;
			            view[i].site.SpotfireQueryID = data[i].SpotfireQueryID;
			            view[i].study.StudyId = data[i].StudyId;
			            view[i].study.StudyName = data[i].StudyName;
			            view[i].visit.VisitId = data[i].VisitId;
			            view[i].visit.VisitName = data[i].VisitName;
			        }
			        m_grid.refresh();
			        if(user_role == "DM" || user_role == "CRA"){
			        	$('#multi_error_message_for_role').show();
			        	$('#multi_button_frame').find('button').attr('disabled','disabled');
			        	$('#cascade_mulit').addClass('nohover');
			        	$('#create_mulit').addClass('nohover');
			        	$('#multi_checkall').css('top','118px');
			        }else{
			        	$('#multi_error_message_for_role').hide();
			        }
			        $("#multi").data("kendoWindow").open().center();
			    },
			    getUserName: function (callback) {
			        var _datasource_username = new kendo.data.DataSource({
			            transport: {
			                read: {
			                    dataType: "json",
			                    url: QMT_RESTFUL_URL + "QMT/GetUserDetailsbyId",
			                }
			            },
			            schema: {
			                data: function (response) {
			                    return [response]
			                }
			            }
			        });
			        _datasource_username.read().then(function () {
			            if (_datasource_username.data()[0].ResponseCode != 'WP2026') {
			                login_username = _datasource_username.data()[0].FirstName;
			                user_role = _datasource_username.data()[0].UserRole;
			                callback();
			            }
			            else {
			                window.location = '<%= System.Configuration.ConfigurationManager.AppSettings["QMTredirectUrl"].ToString() %>';
                    	}
					});
				}
			}
		})();
    $(document).ready(function () {
        $(function () {
            multi.init();
        });
    });
	</script>
</body>
</html>