var landing = (function () {
	var login_username = '';
	var login_full_name = '';
	var _mulit_study_id = '';
	var _mulit_site_id = '';
	var _dashboard = 0;
	var user_role = '';
	var query_select_id = '';
	var spotfire_id ='';
	var query_change_status = 0;
	var search_listobj ={};
	var user_agent = manageSys.getBrowser();
	var user_id = $('#user_id').text();
	var spotfire_url = $('#spotfire_url').text();
	var height = $(window).height();
	var total_height = $('#wp_header').height() + $('#wp_user_function').height() + $('#tab_frame').height() + $('.filter').height() + $('#act_que_list_title').height() + 90;
	var table_height = height - total_height;
	var sider = kendo.fx($("#sider")).slideIn("right"), visible = true;
	var from_time = $("#from_time").kendoDatePicker({
		change: function () {
			if (this.value() == null) {
				this.value("")
			}
			var _to_time = $("#to_time").data('kendoDatePicker');
			var _value = new Date(_to_time.value()).getTime();
			if (new Date(this.value()).getTime() > new Date().getTime()) {
				manageSys.utils.alertMsg("Confirmation alert", '"From" date cannot be greater than Current date.<br/> Please change the date and try again.', function () {});
				this.value(new Date());
				this.value("");
				return
			}
			if (_value > 0) {
				var this_value = new Date(this.value()).getTime();
				if (this_value > _value) {
					manageSys.utils.alertMsg("Confirmation alert", "'To' date cannot be less than 'From' date.<br/>Please select date which is greater than 'From' date and try again.", function () { });
					this.value(new Date());
					this.value("");
				}
			}
		}
	}).data("kendoDatePicker");
	var to_time = $("#to_time").kendoDatePicker({
		change: function () {
			if (this.value() == null) {
				this.value("")
			}
			var _from_time = $("#from_time").data('kendoDatePicker');
			var _value = new Date(_from_time.value()).getTime();
			if (new Date(this.value()).getTime() > new Date().getTime()) {
				manageSys.utils.alertMsg("Confirmation alert", '"To" date cannot be greater than Current date.<br/>Please change the date and try again.', function () { });
				this.value(new Date());
				this.value("");
				return
			}
			if (_value > 0) {
				var this_value = new Date(this.value()).getTime();
				if (this_value < _value) {
					manageSys.utils.alertMsg("Confirmation alert", "'To' date cannot be less than 'From' date.<br/>Please select date which is greater than 'From' date and try again.", function () { });
					this.value(new Date());
					this.value("");
				}
			}
		}
	}).data("kendoDatePicker");

	$("#sider_img").click(function(e){
        if (visible) {
            sider.reverse();
            $('#sider_img').css('right','791px');
            $('#sider_img').css('-webkit-transform','rotate(180deg)');
            $('#sider_img').css('-moz-transform','rotate(180deg)');
            $('#sider_img').css('transform','rotate(180deg)');
            $('#sider_img').css('display','block');
            $('#sider').css('border','solid 4px #00B0F0');
            visible = !visible;
        } else {
        	if(query_change_status > 0 ){
        		manageSys.utils.alertMsg("Confirmation alert", "You have unsaved details, do you want to load the other query or stay in this page.",[{
    				name:'Leave this page',class:'btn yes', css:{}, action:function(e){
    					sider.play();
			            $('#sider_img').css('right','800px');
			            $('#sider').css('border','none');
			            $('#sider_img').css('-webkit-transform','rotate(0deg)');
			            $('#sider_img').css('-moz-transform','rotate(0deg)');
			            $('#sider_img').css('transform','rotate(0deg)');
			            $('#page_laoding').remove();
			            $('#sider_img').css('display','none');
			            query_change_status = 0;
			            visible = !visible;
    				}},{name:'Stay on the Page',class:'btn no', css:{}, action:function(e){
    					return
    			}}]);
        	}else{
        		sider.play();
	            $('#sider_img').css('right','800px');
	            $('#sider').css('border','none');
	            $('#sider_img').css('-webkit-transform','rotate(0deg)');
	            $('#sider_img').css('-moz-transform','rotate(0deg)');
	            $('#sider_img').css('transform','rotate(0deg)');
	            $('#page_laoding').remove();
	            $('#sider_img').css('display','none');
	            visible = !visible;
        	}
        }
        $('#page_laoding').remove();
        e.preventDefault();
    });

	$('#my_que').click(function () {
		manageSys.validsession();
		$('#act_que_list_text').text('My Active Query List');
		$('#my_que').css('color', 'rgb(0,170,255)');
		$('#all_que').css('color', 'black');
		landing.reset_filter_value();
		queryListAll();
	});

	$('#all_que').click(function () {
		manageSys.validsession();
		$('#act_que_list_text').text('All Query List');
		$('#my_que').css('color', 'black');
		$('#all_que').css('color', 'rgb(0,170,255)');
		landing.reset_filter_value();
		allQuerys();
	});

	$('#Create_query').click(function () {
		if (!$("#win").data('kendoWindow')) {
			$('#win_content').html($('#create_query_page').html());
			var viewModel = create_query_vm();
			kendo.bind($('#win_content'), viewModel);
			var w_width = $(window).width() / 3 * 2;
			$("#win").kendoWindow({
				height: '375px',
				width: w_width,
				maxWidth: '800px',
				title: "Create New Query",
				modal: true,
				visible: false,
				resizable: false,
				draggable: false,
				animation: {
					open: {
						duration: 100
					}
				},
				visible: false,
				close: function () {
					var create_study = $("#create_study").data('kendoDropDownList');
					var create_patientid = $("#create_patientid").data('kendoDropDownList');
					var create_crf = $("#create_crf").data('kendoDropDownList');
					var create_visit = $("#create_visit").data('kendoDropDownList');
					var create_assignto = $("#create_assignto").data('kendoDropDownList');
					var value = create_study.value();
					create_study.search("");
					$('#create_site').val("");
					$('#query_text').val("");
					$('#issue').val("");
					create_patientid.value("");
					create_crf.value("");
					create_visit.value("");
					create_study.value("");
					create_assignto.value("DM");
					create_patientid.enable(false);
					create_crf.enable(false);
					create_visit.enable(false);
				}
			});
			$('#win_content').css('display', 'none');
			$("#win").prepend('<div id="load" style="text-align: center;top: 44%;position: absolute;left: 47%;font-size: 12pt;">Loading...</div>');
		}
		$("#win").data("kendoWindow").open().center();
	});

	$('#tab_2').click(function () {
		$('#tab_1').css('background', "url(../imgs/manageSys/tab_2.png)");
		$('#tab_2').css('background', "url(../imgs/manageSys/tab_1.png)");
		$('#query_view_frame').hide();
		$('#sider').hide();
		$('#wp_user_function').hide();
		if (_dashboard == 0) {
			QMT_Dashboard.init($('#dash_frame'));
			manageSys.validsession();
		} else {
			$('#dash_frame').show();
			QMT_Dashboard.resize();
			$('#db_filter').trigger('click');
			var db_program = $("#db_program").data('kendoMultiSelect');
			var db_site = $("#db_site").data('kendoMultiSelect');
			var db_crf = $("#db_crf").data('kendoMultiSelect');
			var db_status = $("#db_status").data('kendoMultiSelect');
			var _value_program = db_program.value();
			var _value_site = db_site.value();
			var _value_crf = db_crf.value();
			var _value_status = db_status.value();
			var _study_list = new kendo.data.DataSource({
				transport: {
		            read: {
		                dataType: "json",
		                url: QMT_RESTFUL_URL + "QMT/GetFilterStudyList"
		            }
		        },
		        schema: {
		            data: "StudyDetailsList"
		        }
			});
			var site_filterCondition = {};
                site_filterCondition.StudyList = [{StudyId:'All'}];
			var _site_list = new kendo.data.DataSource({
				transport: {
	                read: {
	                    dataType: "json",
	                    contentType:'application/json',
	                    url: QMT_RESTFUL_URL+"QMT/FilterSiteList",
	                    type:"POST"
	                },
	                parameterMap:function(){
	                    return JSON.stringify(site_filterCondition);
	                }
	            },
	            schema:{
	                data:"SiteDetailsList",
	                errors: function (response) {
						if (response.ResponseCode != 'WP1022') {
							manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () { });
							if (response.SiteDetailsList == null) {
								return [];
							}
						}
					}
	            }
			});

			var _crf_list = new kendo.data.DataSource({
				transport: {
                    read: {
                        dataType: "json",
                        contentType: 'application/json',
                        url: QMT_RESTFUL_URL + "QMT/GetFilterCRFList",
                        type: "POST"
                    },
                    parameterMap: function () {
                        return JSON.stringify(site_filterCondition);
                    }
                },
                schema: {
                    data: "CRFDetailsList",
                    errors: function (response) {
						if (response.ResponseCode != 'WP1022') {
							manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () { });
							if (response.CRFDetailsList == null) {
								return [];
							}
						}
					}
                }
			});

			var _visit_list = new kendo.data.DataSource({
				transport: {
                    read: {
                        dataType: "json",
                        url: QMT_RESTFUL_URL + "QMT/GetFilterStatusList"
                    }
                },
                schema: {
                    data: "StatusList",
                    errors: function (response) {
						if (response.ResponseCode != 'WP1022') {
							manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () { });
							if (response.StatusList == null) {
								return [];
							}
						}
					}
                }
			});
			
			_study_list.read().then(function(){
				var _data_study = _study_list.data();
				db_program.setDataSource(_data_study);
				db_program.value(_value_program);
			});

			_site_list.read().then(function(){
				var _data_site = _site_list.data();
				db_site.setDataSource(_data_site);
				db_site.value(_value_site);
			});

			_crf_list.read().then(function(){
				var _data_crf = _crf_list.data();
				db_crf.setDataSource(_data_crf);
				db_crf.value(_value_crf);
			});

			_visit_list.read().then(function(){
				var _data_visit = _visit_list.data();
				db_status.setDataSource(_data_visit);
				db_status.value(_value_status);
			});


		}
		_dashboard++;
	});

	$('#tab_1').click(function () {
		$('#tab_1').css('background', "url(../imgs/manageSys/tab_1.png)");
		$('#tab_2').css('background', "url(../imgs/manageSys/tab_2.png)");
		$('#dash_frame').hide();
		$('#query_view_frame').show();
		$('#sider').show();
		if(user_role =='CS' || user_role=="MM"){
			$('#wp_user_function').show();
		}
	});

	$('#mult_p_form').click(function () {
		var patientid_list = {};
		patientid_list.PatientIdList = [];
		var viewModel = mulit_vm();
		kendo.bind($('#multi_content'), viewModel);
		var w_width = Math.floor($(window).width() * 0.8);
		if (!$("#multi").data('kendoWindow')) {
			$("#multi").kendoWindow({
				height: '450px',
				width: '1000px',
				title: "Multi-Patient Query Form",
				modal: true,
				visible: false,
				resizable: false,
				draggable: false,
				animation: {
					open: {
						duration: 100
					}
				},
				visible: false
			});
		}
		$("#multi").data("kendoWindow").open().center();
		var dataSourceaaa = new kendo.data.DataSource({
			schema: {
				model: {
					fields: {
						checkbox: {editable:false},
						patient: { defaultValue: { SiteId: " ", PatientId: " " } },
						study: { defaultValue: { StudyId: "", StudyName: "" } },
						site: { defaultValue: { SiteId: " " } },
						crf: { defaultValue: { CRFId: " ", CRFName: " " } },
						visit: { defaultValue: { VisitId: " ", VisitName: " " } },
						assign: { defaultValue: { name: "DM", text: "DM" } },
						issue: {},
						querytext: {},
						studydatasource:{},
						studydatasourcebka:{},
						crfdatasource:{},
						visitdatasource:{}
					}
				}
			}
		});
		var _datasource_assign = new kendo.data.DataSource({
			data: [
			  { name: "DM", text: "DM" },
			  { name: "CRA", text: "CRA" }
			]
		});

		var multi_auto_complete_data = new kendo.data.DataSource({
			transport: {
				read: {
					dataType: "json",
					contentType: 'application/json',
					url: QMT_RESTFUL_URL + "QMT/GetMultipatientData",
					type: "POST"
				},
				parameterMap: function () {
					return JSON.stringify(patientid_list);
				}
			},
			schema: {
				data: "CreateQueryData",
				errors: function (response) {
					if (response.ResponseCode != 'WP1022') {
						$('#multi_laoding').remove();
						manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () { });
						if (response.CreateQueryData == null) {
							return [];
						}
					}
				}
			}
		});
		
		function mulit_del_status() {
			$('#multi_grid').find(":checkbox").click(function () {
				var checkbox_list = 0;
				var i = 0;
				$('#multi_grid').find(":checkbox").each(function () {
					i++;
					if (this.checked == true) {
						checkbox_list++;
					}
				});
				if (checkbox_list > 0) {
					$('.multi_del_row').css('color', 'rgb(0,170,255)');
					$('.multi_del_row').css('cursor', 'pointer');
					$('.multi_del_row').removeAttr('disabled');
				} else {
					$('.multi_del_row').css('color', '#A6A6A6');
					$('.multi_del_row').css('cursor', 'default');
					$('.multi_del_row').attr('disabled', 'disabled');
				}
				if (checkbox_list == i) {
					$('#multi_checkall')[0].checked = true;
				} else {
					$('#multi_checkall')[0].checked = false;
				}
			});
		};
		function mulit_checkall() {
			$('#multi_checkall').click(function () {
				if ($('#multi_checkall')[0].checked == true) {
					$('#multi_grid').find(":checkbox").each(function () {
						this.checked = true;
					});
					$('.multi_del_row').css('color', 'rgb(0,170,255)');
					$('.multi_del_row').css('cursor', 'pointer');
					$('.multi_del_row').removeAttr('disabled');
				} else {
					$('#multi_grid').find(":checkbox").each(function () {
						this.checked = false;
					});
					$('.multi_del_row').css('color', '#A6A6A6');
					$('.multi_del_row').css('cursor', 'default');
					$('.multi_del_row').attr('disabled', 'disabled')
				}
			})
		};
		$("#multi_grid").kendoGrid({
			width:300,
			height: 295,
			scrollable:true,
			dataSource: dataSourceaaa,
			dataBound: function () {
				mulit_del_status();
				mulit_checkall();
				$(".multi_issue").bind("click keydown",function(){
				 $('.multi_issue').find('input').attr('maxlength','3999');
				});
				$(".multi_querytext").bind("click keydown",function(){
				 $('.multi_querytext').find('input').attr('maxlength','3999');
				});
			},
			rowTemplate: kendo.template($("#multi_template").html()),
			columns: [
	                  	{ field: "checkbox", title: " ", width: "30px" },
	                  	{ field: "patient", title: "Patient ID*", editor: patientDropDownEditor, template: "#=patient.PatientId#" },
	                  	{ field: "study", title: "Study*", editor: studyDropDownEditor, template: "#=study.StudyName#" },
	                  	{ field: "site", title: "Site*", editor: siteDropDownEditor, template: "#=site.SiteId#" },
	                  	{ field: "crf", title: "CRF*", editor: crfDropDownEditor, template: "#=crf.CRFName#", width: 150 },
	                  	{ field: "visit", title: "Visit*", editor: visitDropDownEditor, template: "#=visit.VisitName#", width: 100 },
	                  	{ field: "assign", title: "Assign To*", editor: assignDropDownEditor, template: "#=assign.name#", width: 100 },
	                    { field: "issue", title: "Issue*", width: "150px"},
	                   	{ field: "querytext", title: "Query Text*", width: "150px" }
			],
			editable: true
		});
		var m_grid = $("#multi_grid").data("kendoGrid");
		for (i = 0; i < 10; i++) {
			m_grid.addRow();
		}

		function patientDropDownEditor(container, options) {
			var _select_text = '';
			var m_patient = $('<input required data-text-field="PatientId" data-value-field="PatientId" data-bind="value:' + options.field + '" id="mulit_patientid"/>')
					.appendTo(container)
					.kendoDropDownList({
						autoBind: false,
						filter: "startswith",
						dataSource: {
							transport: {
								read: {
									dataType: "json",
									url: QMT_RESTFUL_URL + "QMT/GetPatientIdFromUserID?SearchPatientId="
								}
							},
							schema: {
								data: "PatientIdList",
								errors: function (response) {
									if (response.ResponseCode != 'WP1022') {
										manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () { });
										if (response.PatientIdList == null) {
											return [];
										}
									}
								}
							}
						},
						close: function () {
							$('.k-textbox').val("");
							var m_patient = $("#mulit_patientid").data('kendoDropDownList');
							if (m_patient.value() != '' && m_patient.value() != ' ') {
								$('body').append('<div id="multi_laoding" style="position: absolute;top: 0px;z-index: 99999;width: 100%;height: 100%;cursor:wait;background-color:rgba(0,0,0,0);"></div>');
								options.model.set('patient', { 'PatientId': _select_text || this.text() });
								patientid_list.PatientIdList[0] = { "PatientId": _select_text || this.text() };
								multi_auto_complete_data.read().then(function () {
									manageSys.validsession();
									var _data = multi_auto_complete_data.data();
									var _static_study = JSON.stringify(_data[0].StudyList);
									var _static_study_data = jQuery.parseJSON(_static_study);
									options.model.set('studydatasource', _data[0].StudyList);
									options.model.set('studydatasourcebka',_static_study_data);
									options.model.set('site', { 'SiteId': _data[0].Site});
									options.model.set('study', { 'StudyName': "","StudyId":"" });
									options.model.set('crf', { 'CRFId': "" });
									options.model.set('crf', { 'CRFName': "" });
									options.model.set('visit', { 'VisitId': "" });
									options.model.set('visit', { 'VisitName': "" });
									var _check_list = [];
									$('#multi_grid').find(":checkbox").each(function () {
										if (this.checked == true) {
											_check_list.push(this.id)
										}
									});
									m_grid.refresh();
									if(_check_list != ""){
										for(m in _check_list){
											$('#'+_check_list[m])[0].checked = true;
										}
									}
									$('#multi_laoding').remove();
								});
							}
						},
						select: function (e) {
							_select_text = e.item.context.outerText;
						},
						open: function () {
							$('#mulit_patientid-list').find('.k-list-filter').find('input').keyup(function (e) {
								var _search_string = $('#mulit_patientid-list').find('.k-textbox').val();
								var _datasource_patientid_search = new kendo.data.DataSource({
									transport: {
										read: {
											dataType: "json",
											url: QMT_RESTFUL_URL + "QMT/GetPatientIdFromUserID?SearchPatientId=" + _search_string
										}
									},
									schema: {
										data: "PatientIdList",
										errors: function (response) {
											if (response.ResponseCode != 'WP1022') {
												manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () { });
												if (response.PatientIdList == null) {
													return [];
												}
											}
										}
									}
								});
								m_patient.setDataSource(_datasource_patientid_search);
							});
						}
					}).data("kendoDropDownList");
		};

		function studyDropDownEditor(container, options) {
			var multi_study = $('<input required data-text-field="StudyName" data-value-field="StudyId" data-bind="value:' + options.field + '" id="multi_study"/>')
					.appendTo(container)
					.kendoDropDownList({
						autoBind: false,
						filter: "startswith",
						dataSource: options.model.studydatasource,
						open: function () {
							var multi_study = $("#multi_study").data('kendoDropDownList');
							if (options.model.patient.PatientId == " "||options.model.patient.PatientId == "") {
								multi_study.enable(false);
							} else {
								multi_study.enable(true);
							}
						},
						change:function(){
							options.model.set('crf', { 'CRFId': "" });
							options.model.set('crf', { 'CRFName': "" });
							options.model.set('visit', { 'VisitId': "" });
							options.model.set('visit', { 'VisitName': "" });
						},
						close: function () {
							$('.k-textbox').val("");
							var multi_study = $("#multi_study").data('kendoDropDownList');
							if (multi_study.value() != '' && multi_study.value() != ' ') {
								$('body').append('<div id="multi_laoding" style="position: absolute;top: 0px;z-index: 99999;width: 100%;height: 100%;cursor:wait;background-color:rgba(0,0,0,0);"></div>');
								var multi_crf_visit = new kendo.data.DataSource({
									transport: {
										read: {
											dataType: "json",
											url: QMT_RESTFUL_URL + "QMT/GetOtherFieldList?StudyId=" + multi_study.value()
										}
									},
									schema: {
										data: function (response) {
											return [response]
										},
										errors: function (response) {
											if (response.ResponseCode != 'WP1022') {
												$('#multi_laoding').remove();
												manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () {});
												//return [];
											}
										}
									}
								});

								multi_crf_visit.read().then(function () {
									var _data = multi_crf_visit.data();
									options.model.set('crfdatasource',_data[0].CRFDetailsList);
									options.model.set('visitdatasource',_data[0].VisitDetailsList);
									var _check_list = [];
									$('#multi_grid').find(":checkbox").each(function () {
										if (this.checked == true) {
											_check_list.push(this.id)
										}
									});
									m_grid.refresh();
									if(_check_list != ""){
										for(m in _check_list){
											$('#'+_check_list[m])[0].checked = true;
										}
									}
									$('#multi_laoding').remove();
								});
							}
						}
					}).data("kendoDropDownList");
		};

		function siteDropDownEditor(container, options) {
			container.text(options.model.site.SiteId);
		};

		function crfDropDownEditor(container, options) {
			var multi_crf = $('<input required data-text-field="CRFName" data-value-field="CRFId" data-bind="value:' + options.field + '" id="multi_crf"/>')
					.appendTo(container)
					.kendoDropDownList({
						autoBind: false,
						filter: "startswith",
						dataSource: options.model.crfdatasource,
						open: function () {
							var multi_crf = $("#multi_crf").data('kendoDropDownList');
							if (options.model.study.StudyName == " " ||options.model.study.StudyName =="") {
								multi_crf.enable(false);
							} else {
								multi_crf.enable(true);
							}
						},
						close: function () {
							$('.k-textbox').val("");
							var multi_crf = $("#multi_crf").data('kendoDropDownList');
							if (multi_crf.dataSource.view().length == 0) {
								container.context.innerHTML = "";
							}
						}
					}).data("kendoDropDownList");
		};

		function visitDropDownEditor(container, options) {
			var multi_visit = $('<input required data-text-field="VisitName" data-value-field="VisitId" data-bind="value:' + options.field + '" id="multi_visit"/>')
				   .appendTo(container)
				   .kendoDropDownList({
				   	autoBind: false,
				   	filter: "startswith",
				   	dataSource: options.model.visitdatasource,
				   	open: function () {
				   		var multi_visit = $("#multi_visit").data('kendoDropDownList');
				   		if (options.model.study.StudyName == " " ||options.model.study.StudyName =="") {
				   			multi_visit.enable(false);
				   		} else {
				   			multi_visit.enable(true);
				   		}
				   	},
				   	close: function () {
				   		var multi_visit = $("#multi_visit").data('kendoDropDownList');
				   		if (multi_visit.dataSource.view().length == 0) {
				   			container.context.innerHTML = "";
				   		}
				   		$('.k-textbox').val("");
				   	}
				   });
		};

		function assignDropDownEditor(container, options) {
			$('<input required data-text-field="text" data-value-field="name" data-bind="value:' + options.field + '"/>')
	            .appendTo(container)
	            .kendoDropDownList({
	            	autoBind: true,
	            	dataSource: _datasource_assign
	            });
		};
	});

	$('#reset').click(function () {
		manageSys.validsession();
		var program = $("#program").data('kendoMultiSelect');
		var site = $("#site").data('kendoMultiSelect');
		var crf = $("#crf").data('kendoMultiSelect');
		var status = $("#status").data('kendoMultiSelect');
		var from_time = $("#from_time").data('kendoDatePicker');
		var to_time = $("#to_time").data('kendoDatePicker');
		program.value('All');
		site.value('All');
		crf.value('All');
		status.value('All');
		program.value('');
		site.value('');
		crf.value('');
		status.value('');
		from_time.value(new Date());
		to_time.value(new Date());
		from_time.value('');
		to_time.value('');
		to_time.min(new Date(1900, 1, 1));
		$('#all_que').trigger('click');
	});

	function grid_checkbox() {
		$('#grid').find(":checkbox").click(function () {
			if (user_role == "CS" || user_role == "MM") {
				var checklist = [];
				$('#grid').find(":checkbox").each(function () {
					if (this.checked == true) {
						checklist.push(this.id);
					}
				});
				if (checklist.length == 1) {
					$('#launch_Spotfire').css('color', 'rgb(0,170,255)');
					$('#launch_Spotfire').css('cursor', 'pointer');
					$('#launch_Spotfire').css('text-decoration', 'underline');
					var _id = checklist.toString();
					spotfire_id = _id;
					var _data = { "pDRUGPROGRAMCD": $('#' + _id).data('pcode'), "pStudy": $('#' + _id).data('study'), "pSTUDYPATIENT": $('#' + _id).data('study'), "pPatient": $('#' + _id).data('patient'), "pCRF": $('#' + _id).data('pcrf'), "pSpotfireId": $('#' + _id).data('spotfireid') };
					var _athree_url = spotfire_url;
					var new_url = _athree_url.replace(/{pDRUGPROGRAMCD}/, _data.pDRUGPROGRAMCD);
					new_url = new_url.replace(/{pStudy}/, _data.pStudy);
					new_url = new_url.replace(/{pSTUDYPATIENT}/, _data.pSTUDYPATIENT);
					new_url = new_url.replace(/{pPatient}/, _data.pPatient);
					if (_data.pSpotfireId == ''){
						new_url = new_url.replace(/{pSpotfireId}/, 'null');
					}else{
						new_url = new_url.replace(/{pSpotfireId}/, _data.pSpotfireId);
					}
					$('#spotfire_url').text(new_url);
				} else {
					$('#launch_Spotfire').css('color', '#A6A6A6');
					$('#launch_Spotfire').css('cursor', 'default');
					$('#launch_Spotfire').css('text-decoration', 'none');
					spotfire_id = '';
				}
			}
		})
	};

	$('#launch_Spotfire').click(function () {
		if ($('#launch_Spotfire').css('text-decoration') != 'underline') {
			return false
		} else {
			$('body').append('<div id="page_laoding" style="font-size: 13pt;position: absolute;top: 0px;z-index: 90;width: 100%;height: 100%;text-align: center;vertical-align: middle;background-color: #A0A0A0;opacity: 0.5;color: white;"><div id="loading_text" style="position: relative;top: 48%;color: rgb(255, 255, 255);z-index: 999;">Loading....</div></div>');
			var _spotfire_url = $('#spotfire_url').text();
			var study_id = $('#'+spotfire_id).data('study');
			var _crfid = $('#'+spotfire_id).data('pcrf');
			var spotfire_list = {"StudyId":study_id,"CRF":_crfid}
			var spotfire_pcrf = new kendo.data.DataSource({
				transport: {
					read: {
						dataType: "json",
						contentType: 'application/json',
						url: QMT_RESTFUL_URL + "QMT/GetSpotfireDisplayName",
						type: "POST"
					},
					parameterMap: function () {
						return JSON.stringify(spotfire_list);
					}
				},
				schema: {
					data: function(response){
						$('#page_laoding').remove();
						if(response == undefined){
							return []
						}else{
							return [response]
						}
					},
					errors: function (response) {
						$('#page_laoding').remove();
						if (response.ResponseCode != 'WP1022') {
							manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function(){});
							if (response == null) {
								return [];
							}
						}
					}
				},
				error:function(e){
					if(e.errorThrown == 'Not Found'){
						$('#page_laoding').remove();
					}
				}
			});
			spotfire_pcrf.read().then(function(){
				var _data = spotfire_pcrf.data()[0];
				var  _open_spotfire_url =  _spotfire_url.replace(/{pCRF}/, _data.SpotfireDisplayName);
				window.open(_open_spotfire_url);
			});
		}
	});

	function aql_resize() {
		var height = $(window).height();
		var total_height = $('#wp_header').height() + $('#wp_user_function').height() + $('#tab_frame').height() + $('.filter').height() + $('#act_que_list_title').height() + 90;
		var table_height = height - total_height;
		if (table_height < 300) {
			table_height = 300
		}
		var grid = $("#grid").data("kendoGrid");
		if(grid){
			$('#grid').height(table_height);
			$('#grid').find('.k-grid-content').height(table_height-88);
		}
	};

	function onselect(arg) {
		var self = this;
		var selected = $.map(self.select(), function (item) {
			return item;
		});
		var _select_id = $(selected).find('input').attr('id');
		var datasouceGetQueryDetails = new kendo.data.DataSource({
			transport: {
				read: {
					dataType: "json",
					url: QMT_RESTFUL_URL + "QMT/" + _select_id + "/GetQueryDetailsById"
				}
			},
			schema: {
				data: function (response) {
					if(response == null){
						$('#page_laoding').remove();
						return [];
					}else{
						return [response];
					}
				},
				errors:function(response){
					if(response.ResponseCode !='WP1022'){
						$('#page_laoding').remove();
						return [];
					}
				}
			}
		});

		var datasouceGetQueryHistory = new kendo.data.DataSource({
			transport: {
				read: {
					dataType: "json",
					url: QMT_RESTFUL_URL + "QMT/" + _select_id + "/GetQueryHistoryById"
				}
			},
			schema: {
				data:function(response){
					if(response.HistoryDetailsList == null){
						return []
					}else{
						return response.HistoryDetailsList
					}
				},
				errors: function (response) {
					if (response.ResponseCode != 'WP1022') {
						$('#page_laoding').remove();
						manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function(){});
						if (response.HistoryDetailsList == null) {
							return [];
						}
					}
				}
			}
		});
		var datasoucestatus = new kendo.data.DataSource({
			transport: {
				read: {
					dataType: "json",
					url: QMT_RESTFUL_URL + "QMT/" + _select_id + "/GetStatusGraphDetails"
				}
			},
			schema: {
				data:function(response){
					if(response.StatusGraphNodeDetailsList == null){
						return [];
					}else{
						return response.StatusGraphNodeDetailsList
					}
				},
				errors: function (response) {
					if (response.ResponseCode != 'WP1022') {
						$('#page_laoding').remove();
						manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function(){});
						if (response.StatusGraphNodeDetailsList == null) {
							return [];
						}
					}
				}
			}
		});
		if (query_change_status > 0) {
			manageSys.utils.alertMsg("Confirmation alert", "You have unsaved details, do you want to load the other query or stay in this page.", [{
				name: 'Leave this page', class: 'btn yes', css: {}, action: function (e) {
					query_select_id = _select_id;
					$('body').append('<div id="page_laoding" style="font-size: 13pt;position: absolute;top: 0px;z-index: 90;width: 100%;height: 100%;text-align: center;vertical-align: middle;background-color: #A0A0A0;opacity: 0.5;color: white;"><div id="loading_text" style="position: relative;top: 48%;color: rgb(255, 255, 255);z-index: 999;">Loading....</div></div>');
					$.when(datasouceGetQueryDetails.read(),datasouceGetQueryHistory.read(),datasoucestatus.read()).done(function(){
						var data_details = datasouceGetQueryDetails.data()[0];
						var data_history = datasouceGetQueryHistory.data();
						var data_status = datasoucestatus.data();
						$('#sider_content').html($('#sider_details').html());
						var viewModel_content = sider_content_vm(data_details);
						kendo.bind($('#sider_content'), viewModel_content);
						var viewModel_history = drivelist(data_history);
						kendo.bind($('#response_history_grid'), viewModel_history);
						var viewModel_status = response_status(data_status);
						kendo.bind($('#query_status_frame'), viewModel_status);
						if (user_role == "CS" || user_role == "MM") {
							$('#query_detail_spotfire').css('display', 'block');
							if(data_details != undefined){
								if (data_details.QueryID != null && data_details.QueryID != 'null') {
									var _id = $('#'+data_details.QueryID);
									var spotfire_id_querydetail = data_details.QueryID;
									var _data = { "pDRUGPROGRAMCD": _id.data('pcode'), "pStudy": _id.data('study'), "pSTUDYPATIENT": _id.data('study'), "pPatient": _id.data('patient'), "pSpotfireId": _id.data('spotfireid'), "pCRF": _id.data('pcrf') };
									var _athree_url = spotfire_url;
									var new_url = _athree_url.replace(/{pDRUGPROGRAMCD}/, _data.pDRUGPROGRAMCD);
									new_url = new_url.replace(/{pStudy}/, _data.pStudy);
									new_url = new_url.replace(/{pSTUDYPATIENT}/, _data.pSTUDYPATIENT);
									new_url = new_url.replace(/{pPatient}/, _data.pPatient);
									//new_url = new_url.replace(/{pCRF}/, _data.pCRF);
									if (_data.pSpotfireId == ''){
										new_url = new_url.replace(/{pSpotfireId}/, 'null');
									}else{
										new_url = new_url.replace(/{pSpotfireId}/, _data.pSpotfireId);
									}
									$('#spotfire_url').text(new_url);
									$('#query_detail_spotfire').removeAttr('disabled');
									$('#query_detail_spotfire').css('cursor', 'pointer');
									$('#query_detail_spotfire').css('color', '#00AAFF');
									$('#query_detail_spotfire').css('text-decoration', 'underline');
								}
							}
							$('#query_detail_spotfire').click(function () {
								var _status = $('#query_detail_spotfire').attr('disabled');
								if (_status == undefined) {
									$('body').append('<div id="page_laoding" style="font-size: 13pt;position: absolute;top: 0px;z-index: 90;width: 100%;height: 100%;text-align: center;vertical-align: middle;background-color: #A0A0A0;opacity: 0.5;color: white;"><div id="loading_text" style="position: relative;top: 48%;color: rgb(255, 255, 255);z-index: 999;">Loading....</div></div>');
									var _spotfire_url = $('#spotfire_url').text();
									var study_id = $('#'+spotfire_id_querydetail).data('study');
									var _crfid = $('#'+spotfire_id_querydetail).data('pcrf');
									var spotfire_list = {"StudyId":study_id,"CRF":_crfid}
									var spotfire_pcrf = new kendo.data.DataSource({
										transport: {
											read: {
												dataType: "json",
												contentType: 'application/json',
												url: QMT_RESTFUL_URL + "QMT/GetSpotfireDisplayName",
												type: "POST"
											},
											parameterMap: function () {
												return JSON.stringify(spotfire_list);
											}
										},
										schema: {
											data: function(response){
												$('#page_laoding').remove();
												if(response == undefined){
													return []
												}else{
													return [response]
												}
											},
											errors: function (response) {
												$('#page_laoding').remove();
												if (response.ResponseCode != 'WP1022') {
													manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function(){});
													if (response == null) {
														return [];
													}
												}
											}
										},
										error:function(e){
											if(e.errorThrown == 'Not Found'){
												$('#page_laoding').remove();
											}
										}
									});
									spotfire_pcrf.read().then(function(){
										var _data = spotfire_pcrf.data()[0];
										var  _open_spotfire_url =  _spotfire_url.replace(/{pCRF}/, _data.SpotfireDisplayName);
										window.open(_open_spotfire_url);
									});
								}
							});
						} else {
							$('#query_detail_spotfire').css('display', 'none');
						}
						if (user_role == "DM" || user_role == "CRA") {
							$('#site_checkbox').css('opacity', '1');
						} else {
							$('#site_checkbox').css('opacity', '0');
							$('#query_site_response_checkbox').attr('disabled', 'disabled');
						}
						$('#page_laoding').remove();
						$("#response_grid").kendoGrid({
							scrollable: false
						}).data("kendoGrid");
						bind_click();
						if (visible) {
							sider.reverse();
							$('#sider_img').css('display', 'block');
							$('#sider_img').css('-webkit-transform', 'rotate(180deg)');
							$('#sider_img').css('-moz-transform', 'rotate(180deg)');
							$('#sider_img').css('transform', 'rotate(180deg)');
							$('#sider_img').css('right', '791px');
							$('#sider').css('border', 'solid 4px #00B0F0');
							visible = !visible;
						}
						$('#query_site_response_checkbox').click(function () {
							if (this.checked == true) {
								$('#site_response_input').show();
							} else {
								$('#site_response_input').hide();
							}
						});

						if (user_agent == 'ie10' || user_agent == 'ie11') {
							$('#query_site_response').css('width', '74.9%');
							$('#query_issue').css('width', '75%');
							$('#query_site_response_checkbox').css('width', '12.7em')
						}
						var query_detail_height = Math.floor(height * 0.9);
						var quert_detail_content_height = Math.floor(query_detail_height - 150);
						$('#sider').css('height', query_detail_height);
						$('#sider_content').css('height', query_detail_height);
						$('#query_content_frame').css('height', quert_detail_content_height);
					});
					query_change_status = 0;
				}
			}, {
				name: 'Stay on the Page', class: 'btn no', css: {}, action: function (e) {
					if (visible) {
						$('#sider_img').trigger('click');
					}
					return
				}
			}]);
		} else {
			query_select_id = _select_id;
			$('body').append('<div id="page_laoding" style="font-size: 13pt;position: absolute;top: 0px;z-index: 90;width: 100%;height: 100%;text-align: center;vertical-align: middle;background-color: #A0A0A0;opacity: 0.5;color: white;"><div id="loading_text" style="position: relative;top: 48%;color: rgb(255, 255, 255);z-index: 999;">Loading....</div></div>');
			$.when(datasouceGetQueryDetails.read(),datasouceGetQueryHistory.read(),datasoucestatus.read()).done(function(){
				var data_details = datasouceGetQueryDetails.data()[0];
				var data_history = datasouceGetQueryHistory.data();
				var data_status = datasoucestatus.data();
				$('#sider_content').html($('#sider_details').html());
				var viewModel_content = sider_content_vm(data_details);
				kendo.bind($('#sider_content'), viewModel_content);
				var viewModel_history = drivelist(data_history);
				kendo.bind($('#response_history_grid'), viewModel_history);
				var viewModel_status = response_status(data_status);
				kendo.bind($('#query_status_frame'), viewModel_status);
				if (user_role == "CS" || user_role == "MM") {
					$('#query_detail_spotfire').css('display', 'block');
					if(data_details != undefined){
						if (data_details.QueryID != null && data_details.QueryID != 'null') {
							var _id = $('#'+data_details.QueryID);
							var spotfire_id_querydetail = data_details.QueryID;
							var _data = { "pDRUGPROGRAMCD": _id.data('pcode'), "pStudy": _id.data('study'), "pSTUDYPATIENT": _id.data('study'), "pPatient": _id.data('patient'), "pSpotfireId": _id.data('spotfireid'), "pCRF": _id.data('pcrf') };
							var _athree_url = spotfire_url;
							var new_url = _athree_url.replace(/{pDRUGPROGRAMCD}/, _data.pDRUGPROGRAMCD);
							new_url = new_url.replace(/{pStudy}/, _data.pStudy);
							new_url = new_url.replace(/{pSTUDYPATIENT}/, _data.pSTUDYPATIENT);
							new_url = new_url.replace(/{pPatient}/, _data.pPatient);
							if (_data.pSpotfireId == ''){
								new_url = new_url.replace(/{pSpotfireId}/, 'null');
							}else{
								new_url = new_url.replace(/{pSpotfireId}/, _data.pSpotfireId);
							}
							$('#spotfire_url').text(new_url);
							$('#query_detail_spotfire').removeAttr('disabled');
							$('#query_detail_spotfire').css('cursor', 'pointer');
							$('#query_detail_spotfire').css('color', '#00AAFF');
							$('#query_detail_spotfire').css('text-decoration', 'underline');
						}
					}
					$('#query_detail_spotfire').click(function () {
						var _status = $('#query_detail_spotfire').attr('disabled');
						if (_status == undefined) {
							$('body').append('<div id="page_laoding" style="font-size: 13pt;position: absolute;top: 0px;z-index: 90;width: 100%;height: 100%;text-align: center;vertical-align: middle;background-color: #A0A0A0;opacity: 0.5;color: white;"><div id="loading_text" style="position: relative;top: 48%;color: rgb(255, 255, 255);z-index: 999;">Loading....</div></div>');
							var _spotfire_url = $('#spotfire_url').text();
							var study_id = $('#'+spotfire_id_querydetail).data('study');
							var _crfid = $('#'+spotfire_id_querydetail).data('pcrf');
							var spotfire_list = {"StudyId":study_id,"CRF":_crfid}
							var spotfire_pcrf = new kendo.data.DataSource({
								transport: {
									read: {
										dataType: "json",
										contentType: 'application/json',
										url: QMT_RESTFUL_URL + "QMT/GetSpotfireDisplayName",
										type: "POST"
									},
									parameterMap: function () {
										return JSON.stringify(spotfire_list);
									}
								},
								schema: {
									data: function(response){
										$('#page_laoding').remove();
										if(response == undefined){
											return []
										}else{
											return [response]
										}
									},
									errors: function (response) {
										$('#page_laoding').remove();
										if (response.ResponseCode != 'WP1022') {
											manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function(){});
											if (response == null) {
												return [];
											}
										}
									}
								},
								error:function(e){
									if(e.errorThrown == 'Not Found'){
										$('#page_laoding').remove();
									}
								}
							});
							spotfire_pcrf.read().then(function(){
								var _data = spotfire_pcrf.data()[0];
								var  _open_spotfire_url =  _spotfire_url.replace(/{pCRF}/, _data.SpotfireDisplayName);
								window.open(_open_spotfire_url);
							});
						}
					});
				} else {
					$('#query_detail_spotfire').css('display', 'none');
				}
				if (user_role == "DM" || user_role == "CRA") {
					$('#site_checkbox').css('opacity', '1');
				} else {
					$('#site_checkbox').css('opacity', '0');
					$('#query_site_response_checkbox').attr('disabled', 'disabled');
				}
				$('#page_laoding').remove();
				$("#response_grid").kendoGrid({
					scrollable: false
				}).data("kendoGrid");
				bind_click();
				if (visible) {
					sider.reverse();
					$('#sider_img').css('display', 'block');
					$('#sider_img').css('-webkit-transform', 'rotate(180deg)');
					$('#sider_img').css('-moz-transform', 'rotate(180deg)');
					$('#sider_img').css('transform', 'rotate(180deg)');
					$('#sider_img').css('right', '791px');
					$('#sider').css('border', 'solid 4px #00B0F0');
					visible = !visible;
				}
				$('#query_site_response_checkbox').click(function () {
					if (this.checked == true) {
						$('#site_response_input').show();
					} else {
						$('#site_response_input').hide();
					}
				});

				if (user_agent == 'ie10' || user_agent == 'ie11') {
					$('#query_site_response').css('width', '74.9%');
					$('#query_issue').css('width', '75%');
					$('#query_site_response_checkbox').css('width', '12.7em')
				}
				var query_detail_height = Math.floor(height * 0.9);
				var quert_detail_content_height = Math.floor(query_detail_height - 150);
				$('#sider').css('height', query_detail_height);
				$('#sider_content').css('height', query_detail_height);
				$('#query_content_frame').css('height', quert_detail_content_height);
			});
		}
	};

	$(window).resize(function () {
		aql_resize();
	});

	$('#filter').click(function () {
		manageSys.validsession();
		var program = $("#program").data('kendoMultiSelect');
		var site = $("#site").data('kendoMultiSelect');
		var crf = $("#crf").data('kendoMultiSelect');
		var status = $("#status").data('kendoMultiSelect');
		var from_time = $("#from_time").data('kendoDatePicker');
		var to_time = $("#to_time").data('kendoDatePicker');
		var program_value = program.value();
		var site_value = site.value();
		var crf_value = crf.value();
		var status_value = status.value();
		var from_time_value = from_time.value();
		var to_time_value = to_time.value();
		if (from_time_value == null) {
			from_time_value = "";
		} else {
			from_time_value = kendo.toString(new Date(from_time.value()), 'M/dd/yyyy');
		}
		if (to_time_value == null) {
			to_time_value = "";
		} else {
			to_time_value = kendo.toString(new Date(to_time.value()), 'M/dd/yyyy');
		}

		if (program_value == '' || program_value.indexOf('All') > -1){
			program_value = ["All"];
		}
		if (site_value == '' || site_value.indexOf('All') > -1){
			site_value = ["All"];
		}
		if (crf_value == '' || crf_value.indexOf('All') > -1){
			crf_value = ["All"];
		}
		/*if (status_value == '' || status_value.indexOf('All') > -1) {
			status_value = ["All"]
		}*/

		if (status_value == '') {
			status_value = ["All"];
		}

		var _myquery = false;
		if ($('#act_que_list_text').text() == 'My Active Query List') {
			_myquery = true;
		}
		var list_obj = {
			"PageNumber": 1, "RowCount": 50, "IsMyQueries": _myquery, "FilterOptionsList": [{ "ColumnName": "Study", "Value": program_value }, { "ColumnName": "Site", "Value": site_value },
			{ "ColumnName": "CRF", "Value": crf_value }, { "ColumnName": "QueryStatus", "Value": status_value }, { "ColumnName": "From", "Value": [from_time_value] }, { "ColumnName": "To", "Value": [to_time_value] }], "StudyCondition": "", "SecondCondition": "", "SortOrder": "", "IsClosedStatus": true,"Filters":[]
		};
		if(_myquery == true){
			$('#act_que_list_text').text('My Active Query List');
		}
		$('.k-grid-content').scrollLeft(0);
		queryListAll(list_obj, true);
	});

	function to_localtime(_time) {
		var _time_lag = new Date().getTimezoneOffset();
		_time_lag = _time_lag * 60 * 1000;
		var utc_seconds = new Date(_time).getTime();
		var local_seconds = utc_seconds - _time_lag;
		var local_time_a = kendo.toString(new Date(local_seconds), 'MMM dd, yyyy');
		return local_time_a
	};

	function to_utctime() {
		var _time_lag = new Date().getTimezoneOffset();
		_time_lag = _time_lag * 60 * 1000;
		var local_seconds = new Date().getTime();
		var utc_seconds = local_seconds + _time_lag;
		var utc_time_a = kendo.toString(new Date(utc_seconds), 'MM/dd/yyyy h:mm:ss tt');
		return utc_time_a;
	};
	function sider_content_vm(data) {
		if(data == undefined){
			data = {
			    "QueryID": "",
			    "StudyId": "",
			    "StudyName": "",
			    "SiteId": "",
			    "SiteName": "",
			    "PatientID": "",
			    "CRFId": "",
			    "CRFName": "",
			    "VisitId": "",
			    "VisitName": "",
			    "Issue": "",
			    "QueryText": "",
			    "AssignTo": "",
			    "Openedby": "",
			    "OpenDate": "",
			    "Status": "",
			    "SiteResonse": false,
			    "SiteInput": "",
			    "ResponseInput": "",
			    "Actions":[],
			    "IsEditable": false,
			    "ResponseCode": "",
			    "ResponseMessage": ""
			}
		}
		var query_study = $("#query_study").kendoDropDownList({
			enable: false,
			dataSource: [data.StudyName]
		}).data("kendoDropDownList");

		var query_site = $("#query_site").kendoDropDownList({
			enable: false,
			dataSource: [data.SiteName]
		}).data("kendoDropDownList");

		var query_patientid = $("#query_patientid").kendoDropDownList({
			enable: false,
			dataSource: [data.PatientID]
		}).data("kendoDropDownList");

		var query_crf = $("#query_crf").kendoDropDownList({
			enable: false,
			dataSource: [data.CRFName]
		}).data("kendoDropDownList");

		var query_visit = $("#query_visit").kendoDropDownList({
			enable: false,
			dataSource: [data.VisitName]
		}).data("kendoDropDownList");

		var query_assignto = $("#query_assignto").kendoDropDownList({
			enable: false,
			dataSource: [data.AssignTo]
		}).data("kendoDropDownList");
		var _a_actions = data.Actions;
		_a_actions.unshift({ "ActionDisplayName": data.Status, "ActionName": "Update" });

		var query_status = $("#query_status").kendoDropDownList({
			enable: true,
			dataSource: _a_actions,
			dataTextField: "ActionDisplayName",
			dataValueField: "ActionName",
			change: function () {
				query_change_status++
			}
		}).data("kendoDropDownList");


		var query_site = $("#query_site").data("kendoDropDownList");
		var query_status = $("#query_status").data("kendoDropDownList");

		if (data.Issue != "") {
			$('#query_issue').val(data.Issue);
		};
		if (data.QueryText != "") {
			$('#query_detail_text').val(data.QueryText);
		};
		if (data.ResponseInput != "") {
			$('#query_response').val(data.ResponseInput);
		};
		if (data.IsEditable == true && data.Status == 'Open') {
			$('.query_button').show();
			query_status.enable(true);
			$('#query_issue').removeAttr('disabled');
			$('#query_detail_text').removeAttr('disabled');
			$('#query_response').removeAttr('disabled');
			$('#query_site_response').removeAttr('disabled');
			$('#query_site_response_checkbox').removeAttr('disabled');
		} else if (data.IsEditable == true && data.Status != 'Open') {
			$('.query_button').show();
			query_status.enable(true);
			$('#query_response').removeAttr('disabled');
			$('#query_site_response').removeAttr('disabled');
			$('#query_site_response_checkbox').removeAttr('disabled');
		}
// customer add 
		else if (data.Status != 'Closed' && user_role == 'CS' && data.Status.toLowerCase() != 'queued for processing') {
            		$('#query_response').removeAttr('disabled');
            		$('.query_button').show();
        	}
//customer_add_end
		else {
			$('.query_button').hide();
			query_status.enable(false);
			$('#query_issue').attr('disabled', 'disabled');
			$('#query_detail_text').attr('disabled', 'disabled');
			$('#query_response').attr('disabled', 'disabled');
			$('#query_site_response').attr('disabled', 'disabled');
			$('#query_site_response_checkbox').attr('disabled', 'disabled');
		}
		// customer_add
		if (user_role == 'DM' || user_role == 'CRA' || data.IsEditable == false) {
			$('#query_issue').attr("disabled", "disabled");
			$('#query_detail_text').attr("disabled", "disabled");
		}
		else {
			$('#query_issue').attr("disabled", "disabled");
			$('#query_detail_text').attr("disabled", "disabled");
			if (data.Status == 'Open') {
				$('#query_issue').removeAttr('disabled');
				$('#query_detail_text').removeAttr('disabled');
			}
		}
		// customer_add_end
		$('#query_issue').change(function () {
			query_change_status++;
		});

		$('#query_detail_text').change(function () {
			query_change_status++;
		});

		$('#query_response').change(function () {
			query_change_status++;
		});

		$('#query_site_response').change(function () {
			query_change_status++;
		});

		var _open_date = data.OpenDate;
		_open_date = to_localtime(_open_date);
		var vm = kendo.observable({
			open_date: function () {
				return _open_date
			},
			open_user: function () {
				return data.Openedby;
			},
			close: function () {
				$('#sider_img').trigger('click');
			},
			title: function () {
				return 'Query Details of ' + data.QueryID
			},
			query_username: function () {
				return data.Openedby
			},
			updata_query_detail: function () {
				manageSys.validsession();
				$('body').append('<div id="query_detail_laoding" style="position: absolute;top: 0px;z-index: 999;width: 100%;height: 100%;cursor:wait;background-color:rgba(0,0,0,0);"></div>');
				var actions = [];
				var _issue_val = $('#query_issue').val();
				var _q_detail_val = $('#query_detail_text').val();
				var _q_response = $('#query_response').val();
				var query_status = $("#query_status").data("kendoDropDownList");
				for (var i = 0; i < data.Actions.length; i++) {
					actions.push(data.Actions[i]);
				}
				var status_val = query_status.value();
				var _siteresponse = data.SiteResonse;
				var _siteinput = data.SiteInput;
// customer_add
				if(_q_response == "" && status_val == 'Closed') {
				$('#query_detail_laoding').remove();
                 manageSys.utils.alertMsg("Confirmation alert", "Please fill your comments.", function () {$('body').css('cursor', 'default');});
                 return
                }		
// customer_add_end
				if (user_role == 'DM' || user_role == 'CRA') {
					var _status = $('#query_site_response_checkbox')[0].checked;
					if (_status == true) {
						_siteresponse = "true";
					} else {
						_siteresponse = "false";
					}
					_siteinput = $('#query_site_response').val();
				}
				var update_list = { "QueryID": data.QueryID, "StudyId": data.StudyId, "StudyName": data.StudyName, "SiteId": data.SiteId, "SiteName": data.SiteName, "PatientID": data.PatientID, "Issue": _issue_val, "CRFId": data.CRFId, "CRFName": data.CRFName, "VisitId": data.VisitId, "VisitName": data.VisitName, "QueryText": _q_detail_val, "AssignTo": data.AssignTo, "Openedby": data.Openedby, "OpenedbyId": data.OpenedById, "OpenDate": data.OpenDate, "Status": data.Status, "SiteResonse": _siteresponse, "SiteInput": _siteinput, "ResponseInput": _q_response, "Action": status_val }
				var update_query_datasource = new kendo.data.DataSource({
					transport: {
						read: {
							dataType: "json",
							contentType: 'application/json',
							url: QMT_RESTFUL_URL + "QMT/PostUpdateQueryDetails",
							type: "POST"
						},
						parameterMap: function () {
							return JSON.stringify(update_list);
						}
					},
					schema: {
						data: function (response) {
							if (response.ResponseCode == "WP1022") {
								var _message = "Clinical Query "+data.QueryID+" updated successfully"
								manageSys.utils.alertMsg("Confirmation alert",_message, function () { });
								$('#query_update_button').removeAttr("disabled");
								$('#query_site_response').val("");
								$('#query_response').val("");
								query_change_status = 0;
								$('#sider_img').trigger('click');
								setTimeout(function () { $('.k-i-refresh').trigger('click') }, 2000);
								query_change_status = 0;
							} else {
								manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function (){});
								$('#query_update_button').removeAttr("disabled");
							}
							$('#query_detail_laoding').remove();
							return [];
						}
					},
					error: function (response) {
						if(response.ResponseCode !="WP1022"){
							manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () { });
							$('#query_detail_laoding').remove();
						}
					}
				});
				update_query_datasource.read();
				$('#query_update_button').attr("disabled", "disabled");
			}
		});
		return vm;
	}
	function create_query_vm() {
		var create_patientid = $("#create_patientid").kendoDropDownList({
			optionLabel: "Select Patient",
			autoBind: false,
			enable: false,
			dataTextField: "PatientId",
			dataValueField: "PatientId",
			filter: "startswith",
			close: function (e) {
				var _data = create_patientid.dataSource.data();
				var _patientid = create_patientid.value();
				if(_patientid !=""){
					for(var i=0;i<_data.length;i++){
						if(_data[i].PatientId == _patientid){
							$('#create_site').val(_data[i].SiteId);
							break;
						}
					}
				}
			},
			open:function(){
				if(user_agent !='ie10' && user_agent !='ie11'){
					setTimeout(function(){$('#create_patientid-list').find('.k-textbox').focus();},0)
				}
			}
		}).data("kendoDropDownList");

		var create_crf = $("#create_crf").kendoDropDownList({
			optionLabel: "Select CRF",
			autoBind: false,
			enable: false,
			dataTextField: "CRFName",
			dataValueField: "CRFId",
			filter: "startswith",
			close: function () {

			}
		}).data("kendoDropDownList");

		var create_visit = $("#create_visit").kendoDropDownList({
			optionLabel: "Select Visit",
			autoBind: false,
			enable: false,
			dataTextField: "VisitName",
			dataValueField: "VisitId",
			filter: "startswith",
			close: function () {

			}
		}).data("kendoDropDownList");

		var create_assignto = $("#create_assignto").kendoDropDownList({
			autoBind: true,
			dataTextField: "text",
			dataValueField: "value",
			dataSource: [{ "text": "DM", "value": "DM" }, { "text": "CRA", "value": "CRA" }],
			close: function () {

			}
		}).data("kendoDropDownList");

		var datasoucestudy = new kendo.data.DataSource({
			transport: {
				read: {
					dataType: "json",
					url: QMT_RESTFUL_URL + "QMT/GetStudyList"
				}
			},
			schema: {
				data: "StudyDetailsList",
				errors: function (response) {
					if (response.ResponseCode != 'WP1022') {
						manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function(){});
						if (response.StudyDetailsList == null) {
							return [];
						}
					}
				}
			}
		});
		datasoucestudy.read().then(function () {
			var data = datasoucestudy.data();
			var create_study_status = 0;
			var stupid_ie = 0;
			var create_study = $("#create_study").kendoDropDownList({
				dataTextField: "StudyName",
				dataValueField: "StudyId",
				dataSource: data,
				filter: "startswith",
				autoBind: false,
				optionLabel: "Select Study",
				open: function () {
					var create_study = $("#create_study").data('kendoDropDownList');
					if (create_study.value() == '') {
						create_study_status++;
						stupid_ie = 1;
					}else{
						stupid_ie = 0;
					}
				},
				close: function (e) {
					var create_study = $("#create_study").data('kendoDropDownList');
					var create_patientid = $("#create_patientid").data('kendoDropDownList');
					var create_crf = $("#create_crf").data('kendoDropDownList');
					var create_visit = $("#create_visit").data('kendoDropDownList');
					var create_assignto = $("#create_assignto").data('kendoDropDownList');
					var value = create_study.value();
					var filterCondition = {};
					filterCondition.FilterType = "All";
					filterCondition.StudyList = [];
					if (value.length == 0) {
						create_patientid.enable(false);
						create_crf.enable(false);
						create_visit.enable(false);
					} else {
						create_patientid.enable(true);
						create_crf.enable(true);
						create_visit.enable(true);
						if (create_study_status != 0) {
							filterCondition.StudyList[0] = { StudyId: value };
							var _datasource_patientid = new kendo.data.DataSource({
								transport: {
									read: {
										dataType: "json",
										contentType: 'application/json',
										url: QMT_RESTFUL_URL + "QMT/PatientIdList",
										type: "POST"
									},
									parameterMap: function () {
										return JSON.stringify(filterCondition);
									}
								},
								schema: {
									data: "PatientDetailsList",
									errors: function (response) {
										if (response.ResponseCode != 'WP1022') {
											manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () {});
											if (response.PatientDetailsList == null) {
												return [];
											}
										}
									}
								}
							});
							var _datasource_crf_visit = new kendo.data.DataSource({
								transport: {
									read: {
										dataType: "json",
										url: QMT_RESTFUL_URL + "QMT/GetOtherFieldList?StudyId=" + value
									}
								},
								schema: {
									data: function (response) {
										return [response]
									},
									errors: function (response) {
										if (response.ResponseCode != 'WP1022') {
											manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () {});
											//return [];
										}
									}
								}
							});

							_datasource_crf_visit.read().then(function () {
								var _data = _datasource_crf_visit.data()[0];
								create_crf.setDataSource(_data.CRFDetailsList);
								create_visit.setDataSource(_data.VisitDetailsList);
							});

							create_patientid.setDataSource(_datasource_patientid);
							$('#create_site').val("");
							create_patientid.value("");
							create_crf.value("");
							create_visit.value("");
							create_study_status = 0;
						}
					}
					if(user_agent == 'ie10' || user_agent=='ie11'){
						if(stupid_ie == 1){
							setTimeout(function(){
								var create_study = $("#create_study").data('kendoDropDownList');
								var value = create_study.value();
								//
								create_patientid.enable(true);
								create_crf.enable(true);
								create_visit.enable(true);
								if (create_study_status != 0) {
									filterCondition.StudyList[0] = { StudyId: value };
									var _datasource_patientid = new kendo.data.DataSource({
										transport: {
											read: {
												dataType: "json",
												contentType: 'application/json',
												url: QMT_RESTFUL_URL + "QMT/PatientIdList",
												type: "POST"
											},
											parameterMap: function () {
												return JSON.stringify(filterCondition);
											}
										},
										schema: {
											data: "PatientDetailsList",
											errors: function (response) {
												if (response.ResponseCode != 'WP1022') {
													manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () {});
													if (response.PatientDetailsList == null) {
														return [];
													}
												}
											}
										}
									});
									var _datasource_crf_visit = new kendo.data.DataSource({
										transport: {
											read: {
												dataType: "json",
												url: QMT_RESTFUL_URL + "QMT/GetOtherFieldList?StudyId=" + value
											}
										},
										schema: {
											data: function (response) {
												return [response]
											},
											errors: function (response) {
												if (response.ResponseCode != 'WP1022') {
													manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () {});
													//return [];
												}
											}
										}
									});

									_datasource_crf_visit.read().then(function () {
										var _data = _datasource_crf_visit.data()[0];
										create_crf.setDataSource(_data.CRFDetailsList);
										create_visit.setDataSource(_data.VisitDetailsList);
									});

									create_patientid.setDataSource(_datasource_patientid);
									$('#create_site').val("");
									create_patientid.value("");
									create_crf.value("");
									create_visit.value("");
									create_study_status = 0;
								}
								//
							},100)
						}
					}
				},
				change: function () {
					create_study_status++;
				}
			}).data("kendoDropDownList");
			$('#load').remove();
			$('#win_content').css('display', 'block');
			var create_patientid = $("#create_patientid").data('kendoDropDownList');
			var create_study = $("#create_study").data('kendoDropDownList');
			create_patientid.filterInput.keyup(function (e) {
				var filterCondition = {};
				filterCondition.SearchString = $('#create_patientid-list').find('.k-textbox').val();
				filterCondition.StudyList = [];
				filterCondition.StudyList[0] = { StudyId: create_study.value() };
				var _datasource_patientid_search = new kendo.data.DataSource({
					transport: {
						read: {
							dataType: "json",
							contentType: 'application/json',
							url: QMT_RESTFUL_URL + "QMT/PatientIdList",
							type: "POST"
						},
						parameterMap: function () {
							return JSON.stringify(filterCondition);
						}
					},
					schema: {
						data: "PatientDetailsList",
						errors: function (response) {
							if (response.ResponseCode != 'WP1022') {
								manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () {});
								if (response.PatientDetailsList == null) {
									return [];
								}
							}
						}
					}
				});
				create_patientid.setDataSource(_datasource_patientid_search);
			});
		});
		var vm = kendo.observable({
			nowdate: function () {
				return kendo.toString(new Date(), 'MMM dd, yyyy');
			},
			cancel: function () {
				manageSys.utils.alertMsg("Confirmation alert", "Are you sure, you want to Cancel?", [{
					name: 'Yes', class: 'btn yes', css: {}, action: function (e) {
						$("#win").data("kendoWindow").close();
					}
				}, {
					name: 'No', class: 'btn no', css: {}, action: function (e) {
						return
					}
				}]);
			},
			username: function () {
				return login_full_name;
			},
			create: function () {
				$('body').css('cursor', 'wait');
				$('#create_query_page_frame').prepend('<div id="create_loading" style="width: 100%;height: 100%;position: absolute;cursor: wait;z-index: 99999;background-color:rgba(0,0,0,0);"></div>');
				var create_site = $("#create_site");
				var create_study = $("#create_study").data('kendoDropDownList');
				var create_patientid = $("#create_patientid").data('kendoDropDownList');
				var create_crf = $("#create_crf").data('kendoDropDownList');
				var create_visit = $("#create_visit").data('kendoDropDownList');
				var create_assignto = $("#create_assignto").data('kendoDropDownList');
				var _a = create_study.value(), _b = $('#create_site').val(), _c = create_patientid.text(), _d = create_crf.value(), _e = create_visit.value(), _f = create_assignto.value(), _g = $('#query_text').val(), _h = $('#issue').val(), _i = to_utctime();
				var _a_text = create_study.text(), _b_text = create_site.val(), _d_text = create_crf.text(), _e_text = create_visit.text();
				var _create_upload_data = [{ "StudyId": _a, "StudyName": _a_text, "SiteId": _b, "SiteName": _b, "PatientID": _c, "CRFId": _d, "CRFName": _d_text, "VisitId": _e, "VisitName": _e_text, "Issue": _h, "QueryText": _g, "AssignTo": _f, "Openedby": login_full_name, "OpenedById": user_id, "OpenDate": _i }];
				if (_a == "" || _c == "" || _d == "" || _e == "" || _f == "" || _g == "" || _h == "") {
					$('body').css('cursor', 'default');
					$('#create_loading').remove();
					manageSys.utils.alertMsg("Confirmation alert", "Please fill all the mandatory fields.", function () {$('body').css('cursor', 'default');});
					return
				}
				manageSys.validsession();
				var create_datasource = new kendo.data.DataSource({
					transport: {
						read: {
							dataType: "json",
							contentType: 'application/json',
							url: QMT_RESTFUL_URL + "QMT/PostCreateQuery",
							type: "POST"
						},
						parameterMap: function () {
							return JSON.stringify(_create_upload_data);
						}
					},
					schema: {
						data: function (response) {
							if (response.ResponseCode == "WP1022") {
								var _query_id = response.CreateResponse[0].QueryId;
								manageSys.utils.alertMsg("Confirmation alert", 'Clinical Data Query ' + _query_id + "  is successfully created", function () {});
								$('#create_create_button').removeAttr("disabled");
								$("#win").data("kendoWindow").close();
								$('#act_que_list_text').text('All Query List');
								$('#my_que').css('color', 'black');
								$('#all_que').css('color', 'rgb(0,170,255)');
								setTimeout(function () { allQuerys() }, 2000 );
							} else {
								manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () {});
								$('#create_create_button').removeAttr("disabled");
							}
							$('body').css('cursor', 'default');
							$('#create_loading').remove();
							return [];
						}
					},
					error: function (response) {
						$('body').css('cursor', 'default');
						$('#create_loading').remove();
					}
				});
				create_datasource.read();
				$('#create_create_button').attr("disabled", "disabled");
			}
		});
		return vm;
	}

	function resp_window_title(button_name) {
		if (user_role == 'CS') {
			if (button_name.toLowerCase() == 'close') {
				return 'Close Multiple Queries';
			} else if (button_name.toLowerCase() == 'clarification to dm/cra/mm') {
				return 'Clarify Multiple Queries';
			} else if (button_name.toLowerCase() == 'update') {
				return 'Update Multiple Queries';
			} else if (button_name.toLowerCase() == 'assign to mm') {
				return 'Assign Multiple Queries to MM';
			} else {
				return 'Bulk Closure';
			}
		} else if (user_role == 'MM') {
			if (button_name.toLowerCase() == 'close') {
				return 'Close Multiple Queries';
			} else if (button_name.toLowerCase() == 'resolve') {
				return 'Resolve Multiple Queries';
			} else if (button_name.toLowerCase() == 'update') {
				return 'Update Multiple Queries';
			} else if (button_name.toLowerCase() == 'clarification to dm/cra') {
				return 'Clarify Multiple Queries'
			} else {
				return 'Bulk Closure';
			}
		} else if (user_role == 'DM') {
			if (button_name.toLowerCase() == 'resolve') {
				return 'Resolve Multiple Queries';
			} else if (button_name.toLowerCase() == 'assign to cra') {
				return 'Assign Multiple Queries to CRA';
			} else if (button_name.toLowerCase() == 'update') {
				return 'Update Multiple Queries';
			} else if (button_name.toLowerCase() == 'queried') {
				return 'Mark Multiple Queries as "Queried"';
			} else if (button_name.toLowerCase() == 'clarification to cs/mm') {
				return 'Clarify Multiple Queries';
			} else {
				return 'Bulk Closure';
			}
		} else if (user_role == 'CRA') {
			if (button_name.toLowerCase() == 'resolve') {
				return 'Resolve Multiple Queries';
			} else if (button_name.toLowerCase() == 'assign to dm') {
				return 'Assign Multiple Queries to DM';
			} else if (button_name.toLowerCase() == 'queried') {
				return 'Mark Multiple Queries as "Queried"';
			} else if (button_name.toLowerCase() == 'clarification to cs/mm') {
				return 'Clarify Multiple Queries';
			} else {
				return 'Bulk Closure';
			}
		} else {
			return 'Bulk Closure';
		}
	};

	function footer_error_message(list, button_name) {
		var _error_message = 'OK';
		if (user_role == "CS") {
			if (button_name == 'Close') {
				for (m in list) {
					if (list[m].status != 'Resolved') {
						_error_message = 'This action is only permitted for queries which are in Resolved Status';
					}
				}
			} else if (button_name == 'Clarification to DM/CRA/MM') {
				for (m in list) {
					if (list[m].status != "Resolved" && list[m].status != "Clarification To CS") {
						_error_message = 'This action is only permitted for queries which are in Resolved or Clarification to CS';
					}
				}
			} else if (button_name == 'Update') {
				for (m in list) {
					if (list[m].status != "Open" && list[m].status != "Resolved" && list[m].status != "Clarification To CS" && list[m].status != "Clarification To CRA" && list[m].status != "Clarification To MM" && list[m].status != "Queried" && list[m].status != "Clarification To DM") {
						_error_message = 'This action is only permitted for queries  which are in Resolved or Clarification to CS or Clarification to CS or Clarification to CRA or Clarification to MM or Queried status';
					}
				}
			} else if (button_name == 'Assign to MM') {
				for (m in list) {
					if (list[m].status != 'Resolved') {
						_error_message = 'This action is only permitted for queries which are in Resolved Status';
					}
				}
			}
		} else if (user_role == "MM") {
			if (button_name == "Close") {
				for (m in list) {
					if (list[m].status != 'Resolved') {
						_error_message = 'This action is only permitted for queries which are in Resolved Status';
					}
				}
			} else if (button_name == "Clarification to DM/CRA") {
				for (m in list) {
					if (list[m].status != "Resolved" && list[m].status != "Clarification To MM") {
						_error_message = 'This action is only permitted for queries which are in Resolved or Clarification to MM';
					}
				}
			} else if (button_name == 'Update') {
				for (m in list) {
					if (list[m].status != "Open" && list[m].status != "Resolved" && list[m].status != "Clarification To CS" && list[m].status != "Clarification To CRA" && list[m].status != "Clarification To MM" && list[m].status != "Queried" && list[m].status != "Clarification To DM" ) {
						_error_message = 'This action is only permitted for queries  which are in Resolved or Clarification to CS or Clarification to CS or Clarification to CRA or Clarification to MM or Queried status';
					}
				}
			} else if (button_name == 'Resolve') {
				for (m in list) {
					if (list[m].status == "Clarification To MM" && list[m].assign == 'MM') {

					} else {
						_error_message = 'This action is only permitted for queries which are in Clarification to MM Status and Assigned to MM';
					}
				}
			}
		} else if (user_role == "DM") {
			if (button_name == 'Resolve') {
				for (m in list) {
					if (list[m].status != 'Open' && list[m].status != 'Clarification To DM' && list[m].status != 'Queried') {
						_error_message = 'This action is only permitted for queries which are in Open or Clarification to DM or Queried status';
					}
				}
			} else if (button_name == 'Clarification to CS/MM') {
				for (m in list) {
					if (list[m].status != 'Open' && list[m].status != 'Clarification To DM' && list[m].status != 'Queried') {
						_error_message = 'This action is only permitted for queries which are in Open or Clarification to DM or Queried status';
					}
				}
			} else if (button_name == 'Queried') {
				for (m in list) {
					if (list[m].status != 'Open' && list[m].status != 'Clarification To DM') {
						_error_message = 'This action is only permitted for queries which are in Open or Clarification to DM status';
					}
				}
			} else if (button_name == 'Assign to CRA') {
				for (m in list) {
					if (list[m].status != 'Open' && list[m].status != 'Clarification To DM') {
						_error_message = 'This action is only permitted for queries which are in Open or Clarification to DM status';
					}
				}
			}
		} else if (user_role == "CRA") {
			if (button_name == "Resolve") {
				for (m in list) {
					if (list[m].status != 'Open' && list[m].status != 'Clarification To CRA' && list[m].status != 'Queried') {
						_error_message = 'This action is only permitted for queries which are in Open or Clarification to CRA or Queried status';
					}
				}
			} else if (button_name == "Clarification to CS/MM") {
				for (m in list) {
					if (list[m].status != 'Open' && list[m].status != 'Clarification To CRA' && list[m].status != 'Queried') {
						_error_message = 'This action is only permitted for queries which are in Open or Clarification to CRA or Queried status';
					}
				}
			} else if (button_name == "Queried") {
				for (m in list) {
					if (list[m].status != 'Open' && list[m].status != 'Clarification To CRA') {
						_error_message = 'This action is only permitted for queries which are in Open or Clarification to CRA status';
					}
				}
			} else if (button_name == "Assign to DM") {
				for (m in list) {
					if (list[m].status != 'Open' && list[m].status != 'Clarification To CRA') {
						_error_message = 'This action is only permitted for queries  which are in Open or Clarification to CRA status';
					}
				}
			}
		}
		return _error_message
	}
	function no_selected_message(buttonname){
		var _no_select_message ="No query selected. Please select at least one query and try again."
		if(buttonname == "Close"){
			_no_select_message = "No query selected. Please select at least one query that needs to be closed and try again.";
		}else if(buttonname=="Update"){
			_no_select_message = "No query selected. Please select at least one query that needs to be updated and try again.";
		}else if(buttonname=="Assign To MM"){
			_no_select_message = "No query selected. Please select at least one query that needs to be assigned and try again.";
		}else if(buttonname=="Clarification to DM/CRA/MM"){
			_no_select_message = "No query selected. Please select at least one query for which status needs to be changed as clarification to DM/CRA/MM and try again.";
		}else if(buttonname=="Queried"){
			_no_select_message = "No query selected. Please select at least one query for which status needs to be changed as queried and try again.";
		}else if(buttonname=="Clarification to DM/CRA"){
			_no_select_message = "No query selected. Please select at least one query for which status needs to be changed as clarification to DM/CRA and try again.";
		}else if(buttonname=="Resolve"){
			_no_select_message = "No query selected. Please select at least one query that needs to be resolved and try again.";
		}
		return _no_select_message;
	}

	function drivelist(listdata) {
		var vm = kendo.observable({
			data: listdata,
			footer_button_click: function (e) {
				manageSys.validsession();
				var checklist = [];
				var _action = $(e.target).data('actionname');
				var _button_text = e.target.innerText;
				$('#grid').find(":checkbox").each(function () {
					if (this.checked == true) {
						checklist.push({ "id": this.id, "status": this.name, "assign": $(this).data('assign') });
					}
				});

				$("#response").kendoWindow({
					height: '231px',
					width: "600px",
					title: "Bulk Closure",
					modal: true,
					visible: false,
					resizable: false,
					draggable: false,
					animation: {
						open: {
							duration: 100
						}
					},
					visible: false
				});
				if (checklist.length > 0) {
					var errormessage = footer_error_message(checklist, _button_text);
					if (errormessage != 'OK') {
						manageSys.utils.alertMsg("Confirmation alert", errormessage, function () {});
						return
					}
				} else {
					var _no_select_message = no_selected_message(_button_text);
					manageSys.utils.alertMsg("Confirmation alert", _no_select_message.toString(), function () {});
					return
				}
				if (checklist.length > 0) {
					$('#response').html($('#respinse_input').html());
					var viewModel = drivelist([]);
					kendo.bind($('#response'), viewModel);
					var response_window = $("#response").data('kendoWindow');
					var _window_title = resp_window_title(_button_text)
					response_window.setOptions({
						title: _window_title
					});
					$("#response").data("kendoWindow").open().center();
				}
				$('#response_close_button').click(function () {
					var _value_textarea = $('#response_input').val();
					if($.trim(_value_textarea) == ""){
						manageSys.utils.alertMsg("Confirmation alert", 'Please fill your comments.', function () {});
						return
					}
					$('body').append('<div id="response_close_button_laoding" style="position: absolute;top: 0px;z-index: 999999;width: 100%;height: 100%;cursor:wait;background-color:rgba(0,0,0,0);"></div>');
					var _id_list = [];
					for (m in checklist) {
						_id_list.push(checklist[m].id);
					}
					var response_val = $('#response_input').val();
					var potquery = { "SelectedQueryList": _id_list, "ResponseInput": response_val, "Action": _action}
					var response_datasouce = new kendo.data.DataSource({
						transport: {
							read: {
								dataType: "json",
								contentType: 'application/json',
								url: QMT_RESTFUL_URL + "QMT/PostAction",
								type: "POST"
							},
							parameterMap: function () {
								return JSON.stringify(potquery);
							}
						},
						schema: {
							data: function (response) {
								/*customer _add*/
								if (response.ResponseCode == "WP1022") {
									var _alert_message = response.ResponseMessage;
									if(_button_text == 'Update'){
										var _id_list = [];
										if(response.ActionResponseList != null){
											for(var i=0;i<response.ActionResponseList.length;i++){
												_id_list.push(response.ActionResponseList[i].QueryId)
											}
											_id_list = _id_list.toString();
										}
									}
									manageSys.utils.alertMsg("Confirmation alert",_alert_message, function () {});
									$("#response").data("kendoWindow").close();
									setTimeout(function () { $('.k-i-refresh').trigger('click') }, 2000);
								} else {
									manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () {});
									$('#response_close_button').removeAttr('disabled');
								}
								$('#response_close_button_laoding').remove();
								return [];
								/*customer _add_end*/
							}
						},
						error: function () {
							$('#response_close_button_laoding').remove();
						}
					});
					response_datasouce.read();
					$('#response_close_button').attr('disabled', 'disabled');
				})
			},
			response_cancel: function () {
				$("#response").data("kendoWindow").close();
			},
			add_row_close: function () {
				var m_grid = $("#multi_grid").data("kendoGrid");
				var _number = $('#add_row_num').val();
				var _grid_length = m_grid.dataSource.view().length;
				var _usable_length = 25 - _grid_length;
				if (_usable_length > 0) {
					if (_number > 0) {
						if (_number > _usable_length) {
							_number = _usable_length;
							manageSys.utils.alertMsg("Confirmation alert", "Maximum number of rows can't exceed limit of 25", function () {});
						}
						manageSys.validsession();
						for (var i = 0; i < _number; i++) {
							m_grid.dataSource.add({});
						}
						if(m_grid.dataSource.data().length < 10){
							$('#multi_grid').find('.k-grid-content').find('table').css('border-bottom',"solid 1px #d5d5d5");
						}else{
							$('#multi_grid').find('.k-grid-content').find('table').css('border-bottom',"none");
						}
						m_grid.refresh();
					}else{
						$("#add_row_window").data("kendoWindow").close();
						return
					}
				}else if(_usable_length == 0 && _number ==0){
					$("#add_row_window").data("kendoWindow").close();
					return
				}else {
					manageSys.utils.alertMsg("Confirmation alert", "Maximum number of rows can't exceed limit of 25", function () {});
				}
				$('.multi_del_row').css('color', '#A6A6A6');
				$('.multi_del_row').css('cursor', 'default');
				$('.multi_del_row').attr('disabled', 'disabled');
				$("#add_row_window").data("kendoWindow").close();
				$('#multi_checkall')[0].checked = false;
			},
			add_row_cancel: function () {
				$("#add_row_window").data("kendoWindow").close();
			}
		});
		return vm;
	}

	function response_status(data) {
		var vm = kendo.observable({
			data: data,
			clarification_date: function () {
				return new Date();
			},
			open_date: function () {
				return new Date();
			},
			close_date: function () {
				return new Date();
			}
		});
		return vm;
	}
	function check_v(data) {
		var _upload_data = [];
		var create_data = to_utctime();
		var _upload_data_obj = { "StudyId": "", "StudyName": "", "SiteId": "", "SiteName": "", "PatientID": "", "CRFId": "", "CRFName": "", "VisitId": "", "VisitName": "", "Issue": "", "QueryText": "", "AssignTo": "", "Openedby": "", "OpenedById": "", "OpenDate": "" };
		var t_bool;
		for (var i = 0; i < data.length; i++) {
			t_bool = [];
			t_bool.push(Boolean($.trim(data[i].crf.CRFId)));
			t_bool.push(Boolean($.trim(data[i].crf.CRFName)));
			t_bool.push(Boolean($.trim(data[i].site.SiteId)));
			t_bool.push(Boolean($.trim(data[i].study.StudyName)));
			t_bool.push(Boolean($.trim(data[i].visit.VisitId)));
			t_bool.push(Boolean($.trim(data[i].visit.VisitName)));
			t_bool.push(Boolean($.trim(data[i].querytext)));
			t_bool.push(Boolean($.trim(data[i].issue)));
			t_bool.push(Boolean($.trim(data[i].patient.PatientId)));
			t_bool.push(Boolean(($.trim(data[i].patient.SiteId + ''))));
			for (var m = 1, l = t_bool.length; m < l; m++) {
				if (t_bool[0] == t_bool[m]) {

				} else {
					return false;
				}
			}
			if (t_bool[0]) {
				_upload_data_obj = { "StudyId": data[i].study.StudyName, "StudyName": data[i].study.StudyName, "SiteId": data[i].site.SiteId, "SiteName": data[i].site.SiteId, "PatientID": data[i].patient.PatientId, "CRFId": data[i].crf.CRFId, "CRFName": data[i].crf.CRFName, "VisitId": data[i].visit.VisitId, "VisitName": data[i].visit.VisitName, "Issue": data[i].issue, "QueryText": data[i].querytext, "AssignTo": data[i].assign.text, "Openedby": login_username, "OpenedById": user_id, "OpenDate": create_data };
				_upload_data.push(_upload_data_obj);
			}
		}
		return _upload_data;
	}

	function mulit_vm(data) {
		var vm = kendo.observable({
			mulit_data: data,
			create_query: function () {
				manageSys.validsession();
				$('body').append('<div id="multi_laoding" style="position: absolute;top: 0px;z-index: 99999;width: 100%;height: 100%;cursor:wait;background-color:rgba(0,0,0,0);"></div>');
				var m_grid = $("#multi_grid").data("kendoGrid");
				var ds = check_v(m_grid.dataSource.data());
				if (ds) {
					if (ds.length == 0) {
						$('#multi_laoding').remove();
						manageSys.utils.alertMsg("Confirmation alert", "Please fill all the mandatory fields.", function () {});
						return;
					}

					var create_datasource_mulit = new kendo.data.DataSource({
						transport: {
							read: {
								dataType: "json",
								contentType: 'application/json',
								url: QMT_RESTFUL_URL + "QMT/PostCreateQuery",
								type: "POST"
							},
							parameterMap: function () {
								return JSON.stringify(ds);
							}
						},
						schema: {
							data: function (response) {
								if (response.ResponseCode == "WP1022") {
									var _m_id_list = [];
									if(response.CreateResponse != null){
										for(var i=0;i<response.CreateResponse.length;i++){
											_m_id_list.push(response.CreateResponse[i].QueryId)
										}
									}
									_m_id_list = _m_id_list.toString();
									if(_m_id_list !=""){
										var _success_message = "Clinical Data Queries "+_m_id_list+" created successfully";
									}else{
										var _success_message = response.ResponseMessage;
									}
									manageSys.utils.alertMsg("Confirmation alert",_success_message, function () {});
									$('#create_mulit').removeAttr("disabled");
									$("#multi").data("kendoWindow").close();
									setTimeout(function () { $('#all_que').trigger('click') }, 3000);
								} else {
									manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () {});
									$('#create_mulit').removeAttr("disabled");
								}
								$('#multi_laoding').remove();
								return [];
							}

						},
						error: function (response) {
							$('#multi_laoding').remove();
						}
					});
					create_datasource_mulit.read();
					$('#create_mulit').attr("disabled", "disabled");
				} else {
					$('#multi_laoding').remove();
					manageSys.utils.alertMsg("Confirmation alert", "Please fill all the mandatory fields.", function () {});
					return;
				}
			},
			cascade: function () {
				var m_grid = $("#multi_grid").data("kendoGrid");
				var view = m_grid.dataSource.view();
				manageSys.validsession();
				if ($.trim(view[0].issue) == "" || $.trim(view[0].querytext) == "" || view[0].study.StudyName == "" || view[0].visit.VisitName == "" || view[0].crf.CRFName == "") {
					manageSys.utils.alertMsg("Confirmation alert", "Please fill the first row to Cascade 'Study', 'CRF', 'Visit', 'Issue' & 'Query Text'", function(){});
					return
				}
				manageSys.utils.alertMsg("Confirmation alert", "This will replace all the Study, CRF, Visit, Issue and Query text fields with the details in first row, do you want to proceed?", [{
					name: 'Yes', class: 'btn yes', css: {}, action: function (e) {					
						for (var i = 1; i < view.length; i++) {
							if (view[i].patient.PatientId != ' ' && view[i].patient.PatientId != '') {
								if (view[0].issue != undefined) {
									view[i].issue = view[0].issue;
								}
								if (view[0].querytext != undefined) {
									view[i].querytext = view[0].querytext;
								}
								view[i].study.StudyName = view[0].study.StudyName;
								view[i].study.StudyId = view[0].study.StudyId;
								view[i].visit.VisitName = view[0].visit.VisitName;
								view[i].visit.VisitId = view[0].visit.VisitId;
								view[i].crf.CRFName = view[0].crf.CRFName;
								view[i].crf.CRFId = view[0].crf.CRFId;
								view[i].crfdatasource = view[0].crfdatasource;
								view[i].visitdatasource = view[0].visitdatasource;
								var _cascade_static_study = JSON.stringify(view[i].studydatasourcebka);
								var _cascade_study_data = jQuery.parseJSON(_cascade_static_study);
								view[i].studydatasource = _cascade_study_data;
							}
						}
						var _check_list = [];
						$('#multi_grid').find(":checkbox").each(function () {
							if (this.checked == true) {
								_check_list.push(this.id)
							}
						});
						m_grid.refresh();
						if(_check_list != ""){
							for(m in _check_list){
								$('#'+_check_list[m])[0].checked = true;
							}
						}
					}
				}, {
					name: 'No', class: 'btn no', css: {}, action: function (e) {
						return
					}
				}]);
			},
			add_row: function () {
				$("#add_row_window").kendoWindow({
					height: '120px',
					width: '400px',
					title: "*Maximum rows allowed in Multi-Patient Form are 25",
					modal: true,
					visible: false,
					resizable: false,
					draggable: false,
					animation: {
						open: {
							duration: 100
						}
					},
					visible: false
				});
				var m_grid = $("#multi_grid").data("kendoGrid");
				var _allow_add_num = 25-m_grid.dataSource.data().length;
				if(_allow_add_num <0){
					_allow_add_num = 0;
				}
				
				$("#add_row_window").data("kendoWindow").open().center();
				$('#add_row_window').html($('#mulit_add_row').html());
				var viewModel = drivelist([]);
				kendo.bind($('#add_row_window'), viewModel);
				$('#add_row_num').keyup(function(){
					if($('#add_row_num').val() < 0 ){
						$('#add_row_num').val('0');
					}
			  		if($('#add_row_num').val() > _allow_add_num){
			  			$('#add_row_num').val(_allow_add_num);
			  		}
			  	});

			  	$('#add_row_num').mouseup(function(){
					if($('#add_row_num').val() < 0 ){
						$('#add_row_num').val('0');
					}
			  		if($('#add_row_num').val() > _allow_add_num){
			  			$('#add_row_num').val(_allow_add_num);
			  		}
			  	});
			},
			remove_row: function () {
				var _status = $(".multi_del_row").attr('disabled')
				if (_status != undefined) {
					return
				} else {
					manageSys.utils.alertMsg("Confirmation alert", "Are you sure you want to remove selected item(s) ?", [{
						name: 'Yes', class: 'btn yes', css: {}, action: function (e) {
							setTimeout(function () {
								manageSys.validsession();
								var _checkbox_list = [];
								var _index_list = [];
								var m_grid = $("#multi_grid").data("kendoGrid");
								var _total_len = m_grid.dataSource.view().length;
								$('#multi_grid').find(":checkbox").each(function () {
									if (this.checked == true) {
										_checkbox_list.push(this.id);
									}
								});
								if (_checkbox_list.length == _total_len) {
									manageSys.utils.alertMsg("Confirmation alert", "Cannot delete all the rows. Click 'Yes' if you want to delete all the rows except first row or 'No' to go back", [{
										name: 'Yes', class: 'btn yes', css: {}, action: function (e) {
											for (m in _checkbox_list) {
												var _index = $('#' + _checkbox_list[m]).parent().parent().index();
												_index_list.push(_index);
											}
											var _data = m_grid.dataSource.data();
											var _new_data = [_data[0]];
											for (m in _index_list) {
												_data[_index_list[m]] = '0';
											}
											for (var i = 1; i < _data.length; i++) {
												if (_data[i] == '0') {
													continue
												} else {
													_new_data.push(_data[i]);
												}
											}
											var _new_datasource = new kendo.data.DataSource({
												schema: {
													data: function () {
														return _new_data
													},
													model: {
														fields: {
															checkbox: {editable:false},
															patient: { defaultValue: { SiteId: " ", PatientId: " " } },
															study: { defaultValue: { StudyId: " ", StudyName: " " } },
															site: { defaultValue: { SiteId: " " } },
															crf: { defaultValue: { CRFId: " ", CRFName: " " } },
															visit: { defaultValue: { VisitId: " ", VisitName: " " } },
															assign: { defaultValue: { name: "DM", text: "DM" } },
															issue: {},
															querytext: {},
															studydatasource:{},
															studydatasourcebka:{},
															crfdatasource:{},
															visitdatasource:{}
														}
													}
												}
											});
											m_grid.setDataSource(_new_datasource);
											if(m_grid.dataSource.data().length < 10){
												$('#multi_grid').find('.k-grid-content').find('table').css('border-bottom',"solid 1px #d5d5d5")
											}else{
												$('#multi_grid').find('.k-grid-content').find('table').css('border-bottom',"none")
											}
											$('.multi_del_row').css('color', 'rgb(166, 166, 166)');
											$('.multi_del_row').css('cursor', 'default');
											$('.multi_del_row').attr('disabled', 'disabled');
											$('#multi_checkall')[0].checked = false;
										}
									}, {
										name: 'No', class: 'btn no', css: {}, action: function (e) {
											return
										}
									}]);
								} else {
									for (m in _checkbox_list) {
										var _index = $('#' + _checkbox_list[m]).parent().parent().index();
										_index_list.push(_index);
									}
									var _data = m_grid.dataSource.data();
									var _new_data = [];
									for (m in _index_list) {
										_data[_index_list[m]] = '0';
									}
									for (var i = 0; i < _data.length; i++) {
										if (_data[i] == '0') {
											continue
										} else {
											_new_data.push(_data[i]);
										}
									}
									var _new_datasource = new kendo.data.DataSource({
										schema: {
											data: function () {
												return _new_data
											},
											model: {
												fields: {
													checkbox: {editable:false},
													patient: { defaultValue: { SiteId: " ", PatientId: " " } },
													study: { defaultValue: { StudyId: " ", StudyName: " " } },
													site: { defaultValue: { SiteId: " " } },
													crf: { defaultValue: { CRFId: " ", CRFName: " " } },
													visit: { defaultValue: { VisitId: " ", VisitName: " " } },
													assign: { defaultValue: { name: "DM", text: "DM" } },
													issue: {},
													querytext: {},
													studydatasource:{},
													studydatasourcebka:{},
													crfdatasource:{},
													visitdatasource:{}
												}
											}
										}
									});
									m_grid.setDataSource(_new_datasource);
									if(m_grid.dataSource.data().length < 10){
										$('#multi_grid').find('.k-grid-content').find('table').css('border-bottom',"solid 1px #d5d5d5")
									}else{
										$('#multi_grid').find('.k-grid-content').find('table').css('border-bottom',"none")
									}
									$('.multi_del_row').css('color', 'rgb(166, 166, 166)');
									$('.multi_del_row').css('cursor', 'default');
									$('.multi_del_row').attr('disabled', 'disabled');
								}
							}, 10)
						}
					}, {
						name: 'No', class: 'btn no', css: {}, action: function (e) {
							return
						}
					}]);
				}
			}
		});
		return vm;
	}
	function bind_click() {
		$('.response_history_title_left').click(function () {
			$('#response_history_frame').slideToggle("normal", function () {
				var _img_src = $('#response_title_img').attr('src');
				if (_img_src == 'imgs/manageSys/filter1.png') {
					$('#response_title_img').attr('src', 'imgs/manageSys/filter.png');
				} else {
					$('#response_title_img').attr('src', 'imgs/manageSys/filter1.png');
				}
			});
		});
	};

	function grid_reload(){
		$('#grid_refresh').off().click(function(){
			$('#filter').trigger('click');
		});
	};

	function grid_excel(){
		$('#grid_excel').off().click(function(){
			$('#act_frame').prepend('<div class="grid_loading" style="width:100%;height:100%;position:absolute;background-color:rgba(255,255,255,0.1);z-index:99"><img src="css/Default/loading-image.gif" style="position:relative;top:40%;left:48%"/></div>');
			var total_excel_num = $("#grid").data('kendoGrid').dataSource.total();
			/*$('.k-i-excel').trigger('click');*/
			search_listobj.PageNumber = 1;
			search_listobj.RowCount = total_excel_num;
			$.ajax({
				url: QMT_RESTFUL_URL + "QMT/QueryList",
				type: "post",
				dataType: "json",
				contentType: 'application/json',
				data: JSON.stringify(search_listobj),
				timeout:90000,
				success: function (data,xhr) {
					if(xhr == 'success'){
						var data = data.QueryListData;
						rows = [
							{cells:[{value:'Query ID', bold: true},{value:'Study', bold: true},{value:'Site', bold: true}
								   ,{value:'Patient ID', bold: true},{value:'Visit', bold: true},{value:'CRF', bold: true}
								   ,{value:'Assign To', bold: true},{value:'Issue', bold: true},{value:'Query Text', bold: true}
								   ,{value:'DM/Clinical Comments', bold: true},{value:'Site Response', bold: true},{value:'Status', bold: true}
								   ,{value:'Opened By', bold: true},{value:'Open Date', bold: true}
							]}
						];
						for(var i = 0, l= data.length;i<l;i++){
							rows.push({cells:[{value:data[i].QueryID},{value:data[i].Study},{value:data[i].Site},{value:data[i].PatientID}
									,{value:data[i].Visit},{value:data[i].CRF},{value:data[i].AssignTo},{value:data[i].Issue}
									,{value:data[i].QueryText},{value:data[i].DMClinicalComments},{value:data[i].Response},{value:data[i].QueryStatus}
									,{value:data[i].OpenedBy},{value:data[i].OpenDate}
								]});
						}
						var workbook = new kendo.ooxml.Workbook({
						  sheets: [
						      {
						      	columns: [{width: 120},{width: 100},{width: 100},{width: 100},{width: 100},{width:200},{width:120},{width:150},{width:120},{width:200},{width:150},{width:150},{width:150},{width:130}],
						        rows: rows
						      }
						  ]
						});
						kendo.saveAs({
						  dataURI: workbook.toDataURL(),
						  fileName: "manageSys.xlsx"
						});
					}else{
						manageSys.utils.alertMsg("Confirmation alert",xhr, function(){});
					}
					$('.grid_loading').remove();
				},
				error: function (e){
					manageSys.utils.alertMsg("Confirmation alert",e.statusText, function(){});
					$('.grid_loading').remove();
				}
			});
		});
	}
	function reload_study_datasource(){
		var datasoucestudy = new kendo.data.DataSource({
			transport: {
				read: {
					dataType: "json",
					url: QMT_RESTFUL_URL + "QMT/GetFilterStudyList"
				}
			},
			schema: {
				data: "StudyDetailsList",
				errors: function (response) {
					if (response.ResponseCode != 'WP1022') {
						manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () { });
						if (response.StudyDetailsList == null) {
							return [];
						}
					}
				}
			}
		});
		var program = $("#program").data('kendoMultiSelect');
		if(program){
			program.setDataSource(datasoucestudy);
		}
	};

	function queryListAll(list_obj, isfilter) {
		var height = $(window).height();
		var total_height = $('#wp_header').height() + $('#wp_user_function').height() + $('#tab_frame').height() + $('.filter').height() + $('#act_que_list_title').height() + 90;
		var table_height = height - total_height;
		$('body').append('<div id="page_laoding" style="font-size: 13pt;position: absolute;top: 0px;z-index: 99;width: 100%;height: 100%;text-align: center;vertical-align: middle;background-color: #A0A0A0;opacity: 0;color: white;"></div>');
		if (list_obj == undefined) {
			list_obj = {
				"PageNumber": 1, "RowCount": 50, "IsMyQueries": true, "FilterOptionsList": [{ "ColumnName": "Study", "Value": ["All"] }, { "ColumnName": "Site", "Value": ["All"] },
				{ "ColumnName": "CRF", "Value": ["All"] }, { "ColumnName": "QueryStatus", "Value": ["All"] }, { "ColumnName": "From", "Value": [""] }, { "ColumnName": "To", "Value": [""] }], "StudyCondition": "", "SecondCondition": "", "SortOrder": "", "IsClosedStatus": true,"Filters":[]
			};
		}
		var hide_width = 0;
		if (user_agent == 'ie10' || user_agent == 'ie11' || user_agent == 'IE 6' || user_agent == 'IE 7' || user_agent == 'IE 8' || user_agent == 'IE 9') {
			hide_width = 100;
		}

		var grid = $("#grid").data('kendoGrid');
		if(!grid){
			grid = $("#grid").kendoGrid({
				dataBound: function (e) {
					grid_checkbox();
					grid_reload();
					grid_excel();
					$('.k-pager-refresh').hide();
					$('#grid').find('th').find('.k-link').attr("title", "click to sort");
					$('#grid').find('thead').find('.k-link').css('position', 'relative');
					$('#grid').find('thead').find('.k-link').css('left', '11px');
					$('#grid').find('thead').find('.k-link:eq(0)').text("");
					$('#launch_Spotfire').css('color', '#A6A6A6');
					$('#launch_Spotfire').css('cursor', 'default');
					$('#launch_Spotfire').css('text-decoration', 'none');
				},
				height: table_height,
				filterable: {
				    extra: false
				},
				sortable: true,
				resizable: true,
				pageable: {
					//pageSizes: [50, 100, 200, "all"],
					refresh: true
				},
				toolbar:[{template: kendo.template($("#tool_bar_template").html())}],
				change: onselect,
				selectable: "row",
				columns: [
				{
	                	field: "IsEditable",
	                	title: "editable",
	                	width: hide_width,
	                	hidden: true
		        }
				,{
						title:" ",
						filterable: false,
						width: 50,
						sortable:false
				}
	              , {
		              	field: "QueryID",
		              	title: "Query ID",
		              	width: 120
	              },
	                {
	                	field: "Study",
	                	title: "Study",
	                	width: 100
	                }, {
	                	field: "Site",
	                	title: "Site",
	                	width: 100
	                },
	                {
	                	field: "PatientID",
	                	title: "Patient ID",
	                	width: 100
	                },
	                {
	                	field: "Visit",
	                	title: "Visit",
	                	width: 100
	                }
	              , {
		              	field: "CRF",
		              	title: "CRF",
		              	width: 150
	              },
	                {
	                	field: "AssignTo",
	                	title: "Assign To",
	                	width: 120
	                }
	              , {
		              	field: "Issue",
		              	title: "Issue",
		              	width: 150
	              },
	                {
	                	field: "QueryText",
	                	title: "Query Text",
	                	width: 120
	                }, {
	                	field: "DMClinicalComments",
	                	title: "DM/Clinical Comments",
	                	width: 200
	                }, {
	                	field: "Response",
	                	title: "Site Response",
	                	width: 150
	                },
	                {
	                	field: "QueryStatus",
	                	title: "Status",
	                	width: 150
	                }, {
	                	field: "OpenedBy",
	                	title: "Opened By",
	                	width: 150
	                }, {
	                	field: "OpenDate",
	                	title: "Open Date",
	                	width: 130
	                }, {
	                	field: "DrugProgramCode",
	                	title: "Drug Program",
	                	width: hide_width,
	                	hidden: true
	                }, {
	                	field: "SpotfireId",
	                	title: "SpotfireId",
	                	width: hide_width,
	                	hidden: true
	                }
				],
				rowTemplate: kendo.template($("#grid_template").html())
			}).data('kendoGrid');
		}

		var grid_datasource = new kendo.data.DataSource({
				error:function (e) {
					if(e.xhr != null && e.status == "error"){
						manageSys.utils.alertMsg("Confirmation alert",e.status, function(){});
					}
				},
				transport: {
					read: {
						dataType: "json",
						contentType: 'application/json',
						url: QMT_RESTFUL_URL + "QMT/QueryList",
						type: 'POST'
					},
					parameterMap: function (d) {
						list_obj.PageNumber = d.page;			
						if (d.sort) {
							if (d.sort.length > 0) {
								list_obj.SortOrder = d.sort[0].field + " " + d.sort[0].dir;
							}
						}

						if(d.filter){
							list_obj.Filters = d.filter.filters;
						}else{
							list_obj.Filters = [];
						}
						var _ori_data = JSON.stringify(list_obj);
						var _ori_data_o = jQuery.parseJSON(_ori_data);
						search_listobj = _ori_data_o;
						return JSON.stringify(list_obj);
					}
				},
				schema: {
					data: function (response) {
						if(response.QueryListData == null){
							$('#page_laoding').remove();
							manageSys.utils.alertMsg("Confirmation alert", "There are no queries created for the studies you have access to",function(){});
							return [];
						}else{
							$('#page_laoding').remove();
							reload_study_datasource();
							if (response.QueryCount == 0) {
								if (isfilter == true || search_listobj.Filters != "") {
									manageSys.utils.alertMsg("Confirmation alert", "There are no queries found for the filtered criteria.",function(){});
								} else {
									manageSys.utils.alertMsg("Confirmation alert", "There are no queries created for the studies you have access to",function(){});
								}
							}
							return response.QueryListData;
						}
					},
					model: {
						fields: {
							QueryID: { type: "string" },
							Study: { type: "string" },
							Site: { type: "string" },
							PatientID: { type: "string" },
							Visit: { type: "string" },
							CRF: { type: "string" },
							AssignTo: { type: "string" },
							Issue: { type: "string" },
							QueryText: { type: "string" },
							DMClinicalComments: { type: "string" },
							Response: { type: "string" },
							QueryStatus: { type: "string" },
							OpenedBy: { type: "string" },
							OpenDate: { type: "string" },
							DrugProgramCode: { type: "string" },
							SpotfireId: { type: "string" },
							IsEditable:{type:"string"}
						}
					},
					total: function (response) {
						return response.QueryCount;
					},
					errors: function (response) {
						if(response == undefined){
							$('#page_laoding').remove();
							return [];
						}
						if (response.ResponseCode != 'WP1022') {
							$('#page_laoding').remove();
							manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function (){});
							if (response.QueryListData == null) {
								return [];
							}
						}
					}
				},
				pageSize: 50,
				serverPaging: true,
				serverFiltering: true,
				serverSorting: true
		});
		grid.setDataSource(grid_datasource);
	};

	function remove_checkbox() {
		var grid = $("#grid").data('kendoGrid');
		var _data = grid.dataSource.data();
		var _hide_checkbox = [];
		for (var i = 0; i < _data.length; i++) {
			if (_data[i].IsEditable == false || _data[i].IsEditable == 'false') {
				_hide_checkbox.push(_data[i].QueryID);
			}
		}
		for (m in _hide_checkbox) {
			$('#' + _hide_checkbox[m]).css('display', 'none');
		}
	};

	function allQuerys() {
		var list_obj = {
			"PageNumber": 1, "RowCount": 50, "IsMyQueries": false, "FilterOptionsList": [{ "ColumnName": "Study", "Value": ["All"] }, { "ColumnName": "Site", "Value": ["All"] },
			{ "ColumnName": "CRF", "Value": ["All"] }, { "ColumnName": "QueryStatus", "Value": ["All"] }, { "ColumnName": "From", "Value": [""] }, { "ColumnName": "To", "Value": [""] }], "StudyCondition": "", "SecondCondition": "", "SortOrder": "", "IsClosedStatus": true,"Filters":[]
		};
		queryListAll(list_obj)
	};
	$('.filter_left').click(function () {
		$('#filter_frame').slideToggle("normal", function () {
			var _img_src = $('#filter_img').attr('src');
			if (_img_src == 'imgs/manageSys/filter1.png') {
				$('#filter_img').attr('src', 'imgs/manageSys/filter.png');
			} else {
				$('#filter_img').attr('src', 'imgs/manageSys/filter1.png');
			}
			aql_resize();
		});

	});

	$('.act_que_list_left').click(function () {
		$('#act_frame').slideToggle("normal", function () {
			var _img_src = $('#act_que_list_img').attr('src');
			if (_img_src == 'imgs/manageSys/filter.png') {
				$('#act_que_list_img').attr('src', 'imgs/manageSys/filter1.png');
			} else {
				$('#act_que_list_img').attr('src', 'imgs/manageSys/filter.png');
			}
		});
	});

	return {
		init: function () {
			$('body').append('<div id="page_laoding_init" style="font-size: 13pt;position: absolute;top: 0px;z-index: 99;width: 100%;height: 100%;text-align: center;vertical-align: middle;background-color: #A0A0A0;opacity: 0;color: white;"></div>');
			if(user_agent =='ie10' || user_agent =='ie11'){
				$('.filter_right').css('right','40px');
				$('#filter_to').css('margin-right',"2.62em");
				$('#filter_from').css('margin-right',"2.2em");
			}
			$('#filter_frame').slideToggle(function () {
				$.ajaxSetup({
					beforeSend: function (xhr) {
						xhr.setRequestHeader("UserId", user_id);
					}
				});
				manageSys.sessioncreation();
				landing.getUserName(function () {
					var displayUserName = "Welcome " + $('#first_name').text() + ',' + $('#last_name').text() + " [" + user_role + "]";
					$('#welcome').text(displayUserName);
					var _study_change = 0;
						var program = $("#program").kendoMultiSelect({
							tagMode: "single",
							optionLabel: "All",
							dataTextField: "StudyName",
							dataValueField: "StudyId",
							placeholder: 'All',
							autoClose: false,
							tagTemplate: kendo.template($("#study_tagTemplate").html()),
							close: function (e) {
								var site = $("#site").data("kendoMultiSelect");
								var crf = $("#crf").data("kendoMultiSelect");
								var program = $("#program").data('kendoMultiSelect');
								if (_study_change != 0 || program.value().length == 0) {
									var value = this.value();
									var filterCondition = {};
									filterCondition.StudyList = [];
									if (value.length == 0) {
										filterCondition.StudyList[0] = { StudyId: 'All' };
									} else {
										if (value.indexOf('All') > -1) {
											value = 'All'
											filterCondition.StudyList[0] = { StudyId: 'All' };
										} else {
											for (m in value) {
												filterCondition.StudyList[m] = { StudyId: value[m] };
											}
										}
									}
									var _dataDource = new kendo.data.DataSource({
										transport: {
											read: {
												dataType: "json",
												contentType: 'application/json',
												url: QMT_RESTFUL_URL + "QMT/FilterSiteList",
												type: "POST"
											},
											parameterMap: function () {
												return JSON.stringify(filterCondition);
											}
										},
										schema: {
											data: "SiteDetailsList",
											errors: function (response) {
												if (response.ResponseCode != 'WP1022') {
													manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () { });
													if (response.SiteDetailsList == null) {
														return [];
													}
												}
											}
										}
									});

									var _dataDource_crf = new kendo.data.DataSource({
										transport: {
											read: {
												dataType: "json",
												contentType: 'application/json',
												url: QMT_RESTFUL_URL + "QMT/GetFilterCRFList",
												type: "POST"
											},
											parameterMap: function () {
												return JSON.stringify(filterCondition);
											}
										},
										schema: {
											data: "CRFDetailsList",
											errors: function (response) {
												if (response.ResponseCode != 'WP1022') {
													manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () { });
													if (response.SiteDetailsList == null) {
														return [];
													}
												}
											}
										}
									});

									site.setDataSource(_dataDource);
									crf.setDataSource(_dataDource_crf);
									site.value("");
									_study_change = 0;
								}
							},
							select: function (e) {
								var program = $("#program").data('kendoMultiSelect');
								var _select = e.item.text();
								var _value = program.value();
								var view = program.dataSource.view();
								var _dropdown_value = [];
								if (_select == "All") {
									if (_value.indexOf('All') == -1) {
										for (var i = 1 ; i < view.length; i++) {
											_dropdown_value.push(view[i].StudyId);
										}
										program.value(_dropdown_value);
									} else if (_value.indexOf('All') > -1) {
										program.value('All');
									}
								}
							},
							change: function (e) {
								_study_change++;
								var program = $("#program").data('kendoMultiSelect');
								var _value = program.value();
								var view = program.dataSource.view();
								if (_value.length < view.length) {
									if (_value.indexOf('All') > -1) {
										var _new_value = [];
										for (var i = 0; i < _value.length; i++) {
											if (_value[i] != 'All') {
												_new_value.push(_value[i]);
											}
										}
										program.value(_new_value);
									}
								}
								if (_value.length == view.length - 1) {
									if (_value.indexOf('All') == -1) {
										_value.push('All');
										program.value(_value)
									}
								}
							}
						}).data("kendoMultiSelect");
					var site_filterCondition = {};
					site_filterCondition.StudyList = [{ StudyId: 'All' }];
					var site = $("#site").kendoMultiSelect({
						tagMode: "single",
						optionLabel: "All",
						dataTextField: "SiteName",
						dataValueField: "SiteId",
						cascadeFrom: "program",
						placeholder: 'All',
						autoClose: false,
						dataSource: {
							transport: {
								read: {
									dataType: "json",
									contentType: 'application/json',
									url: QMT_RESTFUL_URL + "QMT/FilterSiteList",
									type: "POST"
								},
								parameterMap: function () {
									return JSON.stringify(site_filterCondition);
								}
							},
							schema: {
								data: "SiteDetailsList",
								errors: function (response) {
									if (response.ResponseCode != 'WP1022') {
										manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () { });
										if (response.SiteDetailsList == null) {
											return [];
										}
									}
								}
							}
						},
						tagTemplate: kendo.template($("#site_tagTemplate").html()),
						select: function (e) {
							var site = $("#site").data('kendoMultiSelect');
							var _select = e.item.text();
							var _value = site.value();
							var view = site.dataSource.view();
							var _dropdown_value = [];
							if (_select == "All") {
								if (_value.indexOf('All') == -1) {
									for (var i = 1 ; i < view.length; i++) {
										_dropdown_value.push(view[i].SiteId);
									}
									site.value(_dropdown_value);
								} else if (_value.indexOf('All') > -1) {
									site.value('All');
								}
							}
						},
						change: function (e) {
							var site = $("#site").data('kendoMultiSelect');
							var _value = site.value();
							var view = site.dataSource.view();
							if (_value.length < view.length) {
								if (_value.indexOf('All') > -1) {
									var _new_value = [];
									for (var i = 0; i < _value.length; i++) {
										if (_value[i] != 'All') {
											_new_value.push(_value[i]);
										}
									}
									site.value(_new_value);
								}
							}
							if (_value.length == view.length - 1) {
								if (_value.indexOf('All') == -1) {
									_value.push('All');
									site.value(_value)
								}
							}
						}
					}).data("kendoMultiSelect");

					var crf = $("#crf").kendoMultiSelect({
						tagMode: "single",
						dataTextField: "CRFName",
						dataValueField: "CRFId",
						cascadeFrom: "program",
						placeholder: 'All',
						autoClose: false,
						tagTemplate: kendo.template($("#crf_tagTemplate").html()),
						dataSource: {
							transport: {
								read: {
									dataType: "json",
									contentType: 'application/json',
									url: QMT_RESTFUL_URL + "QMT/GetFilterCRFList",
									type: "POST"
								},
								parameterMap: function () {
									return JSON.stringify(site_filterCondition);
								}
							},
							schema: {
								data: "CRFDetailsList",
								errors: function (response) {
									if (response.ResponseCode != 'WP1022') {
										manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function () { });
										if (response.CRFDetailsList == null) {
											return [];
										}
									}
								}
							}
						},
						select: function (e) {
							var crf = $("#crf").data('kendoMultiSelect');
							var _select = e.item.text();
							var _value = crf.value();
							var view = crf.dataSource.view();
							var _dropdown_value = [];
							if (_select == "All") {
								if (_value.indexOf('All') == -1) {
									for (var i = 1 ; i < view.length; i++) {
										_dropdown_value.push(view[i].CRFId);
									}
									crf.value(_dropdown_value);
								} else if (_value.indexOf('All') > -1) {
									crf.value('All');
								}
							}
						},
						change: function (e) {
							var crf = $("#crf").data('kendoMultiSelect');
							var _value = crf.value();
							var view = crf.dataSource.view();
							if (_value.length < view.length) {
								if (_value.indexOf('All') > -1) {
									var _new_value = [];
									for (var i = 0; i < _value.length; i++) {
										if (_value[i] != 'All') {
											_new_value.push(_value[i]);
										}
									}
									crf.value(_new_value);
								}
							}
							if (_value.length == view.length - 1) {
								if (_value.indexOf('All') == -1) {
									_value.push('All');
									crf.value(_value)
								}
							}
						}
					}).data("kendoMultiSelect");

					var status = $("#status").kendoMultiSelect({
						tagMode: "single",
						optionLabel: "All",
						dataTextField: "StatusName",
						dataValueField: "StatusId",
						cascadeFrom: "program",
						placeholder: 'All',
						tagTemplate: kendo.template($("#status_tagTemplate").html()),
						autoClose: false,
						dataSource: {
							transport: {
								read: {
									dataType: "json",
									url: QMT_RESTFUL_URL + "QMT/GetFilterStatusList"
								}
							},
							schema: {
								data: "StatusList",
								errors: function (response) {
									if (response.ResponseCode != 'WP1022') {
										manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function(){});
										if (response.StatusList == null) {
											return [];
										}
									}
								}
							}
						},
						select: function (e) {
							var status = $("#status").data('kendoMultiSelect');
							var _select = e.item.text();
							var _value = status.value();
							var view = status.dataSource.view();
							var _dropdown_value = [];
							if (_select == "All") {
								if (_value.indexOf('All') == -1) {
									for (var i = 1 ; i < view.length; i++) {
										_dropdown_value.push(view[i].StatusId);
									}
									status.value(_dropdown_value);
								} else if (_value.indexOf('All') > -1) {
									status.value('All');
								}
							}
						},
						change: function (e) {
							var status = $("#status").data('kendoMultiSelect');
							var _value = status.value();
							var view = status.dataSource.view();
							if (_value.length < view.length) {
								if (_value.indexOf('All') > -1) {
									var _new_value = [];
									for (var i = 0; i < _value.length; i++) {
										if (_value[i] != 'All') {
											_new_value.push(_value[i]);
										}
									}
									status.value(_new_value);
								}
							}
							if (_value.length == view.length - 1) {
								if (_value.indexOf('All') == -1) {
									_value.push('All');
									status.value(_value)
								}
							}
						}
					}).data("kendoMultiSelect");

					var footer_button_datasource = new kendo.data.DataSource({
						transport: {
							read: {
								dataType: "json",
								url: QMT_RESTFUL_URL + "QMT/GetActionNames"
							}
						},
						schema: {
							data: "ActionNameList",
							errors: function (response) {
								if (response.ResponseCode != 'WP1022') {
									manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function(){});
									if (response.ActionNameList == null) {
										return [];
									}
								}
							}
						}
					});
					footer_button_datasource.read().then(function () {
						var data = footer_button_datasource.data();
						var viewModel = drivelist(data);
						kendo.bind($(".act_button_frame"), viewModel);
					})

					$("#required").kendoMultiSelect({
						autoClose: false,
						tagMode: "single",
						height: '30px'
					});
					$('#page_laoding_init').remove();
					if (user_role == 'DM' || user_role == 'CRA') {
						$('#my_que').hide();
						$('#myquery_span').hide();
						$('#wp_user_function').hide();
						$('#all_que').hide();
						allQuerys();
					} else if (user_role == 'CS' || user_role == 'MM') {
						allQuerys();
					} else {
						$('#act_que_list_text').text('My Active Query List');
						$('#my_que').css('color', 'rgb(0,170,255)');
						$('#all_que').css('color', 'black');
						queryListAll();
					}
					landing.hide_querydetail_window();
					if(user_agent == 'ie10' || user_agent == 'ie11'){
						$('#from_time').attr('disabled','true');
						$('#to_time').attr('disabled','true');
					}else{
						$('#from_time').attr('readonly','true');
						$('#to_time').attr('readonly','true');
					}
				});
			});

		}, // end of init
		getPieCharDataList: function (list,isaging) {
			manageSys.validsession();
			$('#tab_1').trigger('click');
			var list_obj = { "PageNumber": 1, "RowCount": 50, "IsMyQueries": false, "FilterOptionsList": list, "StudyCondition": "", "SecondCondition": "", "SortOrder": "", "IsClosedStatus": true,  "IsAgeing": isaging,"Filters":[]};
			queryListAll(list_obj);
		},
		getUserName: function (callback) {
			var _datasource_username = new kendo.data.DataSource({
				transport: {
					read: {
						dataType: "json",
						url: QMT_RESTFUL_URL + "QMT/GetUserDetailsbyId"
					}
				},
				schema: {
					data: function (response) {
						if (response == null) {
							manageSys.utils.alertMsg("Confirmation alert","Sorry This service is currently unavailable Please reload this page again.", function(){});
							return [];
						}else{
							return [response]
						}
					},
					errors:function(response){
						if(response == undefined){
							manageSys.utils.alertMsg("Confirmation alert","Sorry This service is currently unavailable Please reload this page again.", function(){});
							return [];
						}
					}
				},
				error:function (e) {
					if(e.xhr != null && e.status == "error"){
						manageSys.utils.alertMsg("Confirmation alert",e.status, function(){});
					}
				}
			});
			_datasource_username.read().then(function () {
				if (_datasource_username.data()[0].ResponseCode == 'WP2026') {
                    			window.location = '/Unauthorised.aspx';
                		}
                		else if (_datasource_username.data()[0].ResponseCode == 'WP2028') {
                    			login_username = _datasource_username.data()[0].FirstName;
                    			login_full_name = _datasource_username.data()[0].FirstName + ", " + _datasource_username.data()[0].LastName;
                    			user_role = _datasource_username.data()[0].UserRole;
                    			manageSys.u1167tils.alertMsg("Error alert", _datasource_username.data()[0].ResponseMessage, function () { });
                		}
                		else {
                    			login_username = _datasource_username.data()[0].FirstName;
                    			login_full_name = _datasource_username.data()[0].FirstName + ", " + _datasource_username.data()[0].LastName;
                    			user_role = _datasource_username.data()[0].UserRole;
                    			callback();
                		}
			});
		},
		hide_querydetail_window: function () {
			$('body').keyup(function (event) {
				var keycode;
				if (window.event) {
					keycode = event.keyCode;
				} else if (event.which) {
					keycode = event.which;
				}
				if(keycode == 27){
			       	if(!visible){
			       		$('#sider_content').find('input').blur();
				       	$('#sider_content').find('textarea').blur();
						$('#sider_img').trigger('click');
					}
		       }
			})
		},
		multi_copy_pase: function (data) {
			var _datasource_multi_details = new kendo.data.DataSource({
				transport: {
					read: {
						dataType: "json",
						contentType: 'application/json',
						url: QMT_RESTFUL_URL + "QMT/GetPatientDetails",
						type: "POST"
					},
					parameterMap: function () {
						return JSON.stringify(data);
					}
				},
				schema: {
					data: "CreateQueryData",
					errors: function (response) {
						if (response.ResponseCode != 'WP1022') {
							manageSys.utils.alertMsg("Confirmation alert", response.ResponseMessage, function(){});
							if (response.CreateQueryData == null) {
								return [];
							}
						}
					}
				}
			});
			_datasource_multi_details.read().then(function () {
				var _data = _datasource_multi_details.data();
				var m_grid = $("#multi_grid").data("kendoGrid");
				var _new_datasource = new kendo.data.DataSource({
					schema: {
						data: function () {
							return [];
						},
						model: {
							fields: {
								checkbox: {editable:false},
								patient: { defaultValue: { SiteId: " ", PatientId: " " } },
								study: { defaultValue: { StudyId: " ", StudyName: " " } },
								site: { defaultValue: { SiteId: " " } },
								crf: { defaultValue: { CRFId: " ", CRFName: " " } },
								visit: { defaultValue: { VisitId: " ", VisitName: " " } },
								assign: { defaultValue: { name: "DM", text: "DM" } },
								issue: {},
								querytext: {},
								studydatasource:{},
								studydatasourcebka:{},
								crfdatasource:{},
								visitdatasource:{}
							}
						}
					}
				});
				$('.multi_del_row').css('color', 'rgb(166, 166, 166)');
				$('.multi_del_row').css('cursor', 'default');
				$('.multi_del_row').attr('disabled', 'disabled');
				$('#multi_checkall')[0].checked = false;
				m_grid.setDataSource(_new_datasource);
				for(i=0;i<1;i++){
					m_grid.addRow();
				}
				m_grid.refresh();
				var view = m_grid.dataSource.view();
				if (_data.length > view.length) {
					var _add_length = _data.length - view.length;
					for (var i = 0; i < _add_length; i++) {
						m_grid.addRow();
						m_grid.refresh()
					}
				}
				var view = m_grid.dataSource.view();
				for (var i = 0; i < _data.length; i++) {
					view[i].patient.PatientId = _data[i].PatieintId;
					view[i].patient.SiteId = _data[i].Site;
					view[i].site.SiteId = _data[i].Site;
					view[i].studydatasource = _data[i].StudyList;
				}
				if(m_grid.dataSource.data().length < 10){
					$('#multi_grid').find('.k-grid-content').find('table').css('border-bottom',"solid 1px #d5d5d5")
				}else{
					$('#multi_grid').find('.k-grid-content').find('table').css('border-bottom',"none")
				}
				m_grid.refresh();
			})
		},
		reset_filter_value:function(){
			var program = $("#program").data('kendoMultiSelect');
			var site = $("#site").data('kendoMultiSelect');
			var crf = $("#crf").data('kendoMultiSelect');
			var status = $("#status").data('kendoMultiSelect');
			var from_time = $("#from_time").data('kendoDatePicker');
			var to_time = $("#to_time").data('kendoDatePicker');
			program.value('All');
			site.value('All');
			crf.value('All');
			status.value('All');
			program.value('');
			site.value('');
			crf.value('');
			status.value('');
			from_time.value(new Date());
			to_time.value(new Date());
			from_time.value('');
			to_time.value('');
			to_time.min(new Date(1900, 1, 1));
		}
	}
})();

var SheetManager = (function () {
	var _window, _sheet, validate_ing = false;
	var regx = /[\r\n]/g;
    var _activeCellQuery = '.k-spreadsheet-active-cell td',
		_editCellQuery = '.k-spreadsheet-cell-editor';
	var isclosed = false;

	var clearSheetStyle = function () {
        if(!_sheet) return;
		_sheet.activeSheet().range('A1:B25').color('black');
		$('#win_spreadsheet_content').find(_editCellQuery).removeClass('cell_err_style');
	}

    var onRender = function (e) {
		if(!_sheet) return;
        _sheet.element.find('.k-spreadsheet-column-header').find('td:first').text('Patient ID');
		$('#win_spreadsheet_content').find(_activeCellQuery).removeClass('cell_err_style');
    }
	return {
		init: function (container) {
			_sheet = $("#win_spreadsheet_content").kendoSpreadsheet({
				rows: 25,
				columns:2,
				columnWidth:300,
				toolbar: false,
				sheetsbar: false,
                render: onRender
			}).data("kendoSpreadsheet");

			_window = $('#win_spreadsheet').kendoWindow({
				width: '348px',
				height: '577px',
				visible: false,
				modal: true,
				resizable: false,
				draggable: false,
				close: function () {
					if(validate_ing) return;
					_sheet.destroy();
					$('#ss_content_mask').hide();
					$('#win_spreadsheet_content').empty();
					_sheet = $("#win_spreadsheet_content").kendoSpreadsheet({
						rows: 25,
						columns:2,
						columnWidth:300,
						toolbar: false,
						sheetsbar: false,
						render: onRender
					}).data("kendoSpreadsheet");
				},
				title: "*Validation only for Patient ID column"
			}).data('kendoWindow');
			_sheet.element.find('.k-spreadsheet-column-header').find('td:first').text('Patient ID');
			_sheet.element.find(_editCellQuery).on('focus',function(e){ $(this).removeClass('cell_err_style'); });
		},
		insert: function () {
            manageSys.validsession();
			var aSheet = _sheet.activeSheet();
			var _aRange = _sheet.activeSheet().activeCell().toString(),
				_aValue = ( _sheet.element.find(_activeCellQuery).text() || _sheet.element.find(_editCellQuery).text()).trim().replace(regx, "") +'';
			var _cell_value,_range, param = { PatientIdList: [] }, _data_ = [], record = {}, err_record = [];

			for (var i = 1; i <= 25; i++) {
				_cell_value = (aSheet.range('A' + i).value() + '').trim().replace(regx, "");
				_range = ('A' + i + ':' + 'A' + i);
				if (_cell_value != "null" && _cell_value != '') {
					_data_.push(_cell_value || _aValue);
					record[_cell_value] = record[_cell_value] || [];
					record[_cell_value].push(_range);
				} else if (_range == _aRange && _aValue != '') {
					_sheet.activeSheet().range(_aRange).value(_aValue);
					record[_aValue] = record[_aValue] || [];
					record[_aValue].push(_range);
					_data_.push(_aValue);
				}
			}
			if (!_data_.length) {
                manageSys.utils.alertMsg("Error alert", "There is no PatientID found for the validation", function () {});
				return;
			}
			if (_data_.length > 25) {
				_data_ = _data_.slice(0, 24);
			}
			param.PatientIdList = _data_;
			if (validate_ing) return;
			validate_ing = true;
			clearSheetStyle();
			$('#ss_content_mask').show();
			$.ajax({
				url: QMT_RESTFUL_URL + "QMT/ValidatePatientIds",
				type: "post",
				dataType: "json",
				contentType: 'application/json',
				data: JSON.stringify(param),
				success: function (data) {
					validate_ing = false;
					$('#ss_content_mask').hide();

					if (data.ResponseCode == 'WP2013') {
                        manageSys.utils.alertMsg("Error alert", data.ResponseMessage, function () { });
					}
					if (data.ResponseCode == 'WP2026') {
                        manageSys.utils.alertMsg("Error alert", data.ResponseMessage, function () { });
					}

					var details = data.PatientValidationDetails;
					if (!details)
						return;
					for (var i = 0, l = details.length; i < l; i++) {
						if (details[i].IsValid == 'NOTVALID') {
							err_record.push(details[i].PatieintId);
						}
					}
					if (!err_record.length) {
						landing.multi_copy_pase(param);
						SheetManager.close();
					} else {
						var error_arr_str = err_record.join(',');
						if(_aValue != '' && error_arr_str.indexOf(_aValue) > -1){
							$('#win_spreadsheet_content').find(_activeCellQuery+', '+_editCellQuery).addClass('cell_err_style');
						}
						var pId;
						for (var i = 0, l = details.length; i < l; i++) {
							if (details[i].IsValid == 'NOTVALID') {
								pId = details[i].PatieintId;
								if(record[pId]){
									for (var x = 0; x < record[pId].length; x++) {
										aSheet.range(record[pId][x]).color('red');
									}
								}
							}
						}

                        manageSys.utils.alertMsg("Error alert", 'Please correct the Patient IDs marked in Red and try to validate again', function () { });
					}
				},
				error: function () {
					$('#ss_content_mask').hide();
                    manageSys.utils.alertMsg("Error alert", 'Something wrong happened while validating the Patient Ids', function () { });
				}
			});
		},
		open: function () {
			_window.open();
			_window.center();
		},
		close: function () {
			_window.close();
		}
	}
}());

$(document).ready(function () {
	$(function () {
		landing.init();
		SheetManager.init();
	});
});
